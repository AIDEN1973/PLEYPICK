# ğŸ› ï¸ BrickBox ì‹œìŠ¤í…œ ì—ëŸ¬ ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-10-13  
**ìˆ˜ì • ë²”ìœ„**: Frontend + Backend + Worker

---

## ğŸ“‹ ìˆ˜ì • ë‚´ìš© ìš”ì•½

### 1ï¸âƒ£ **Frontend ì—ëŸ¬ ìˆ˜ì •**

#### âœ… Storage ì´ë¯¸ì§€ ì²´í¬ 400 ì—ëŸ¬ í•´ê²°
**íŒŒì¼**: `src/composables/useAutoImageMigration.js`

**ë¬¸ì œ**:
- GET ìš”ì²­ìœ¼ë¡œ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì‹œ 400 Bad Request ë°œìƒ
- ë¸Œë¼ìš°ì € ì½˜ì†”ì— ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë¡œê·¸ ë‹¤ìˆ˜ ë°œìƒ

**ìˆ˜ì •**:
```javascript
// âŒ ì´ì „ (GET ìš”ì²­)
const response = await fetch(url, { 
  method: 'GET',
  headers: { 'Range': 'bytes=0-0' }
})

// âœ… ìˆ˜ì • (HEAD ìš”ì²­)
const response = await fetch(url, { 
  method: 'HEAD',
  signal: AbortSignal.timeout(3000)
})
```

---

#### âœ… `image_metadata` í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì˜¤ë¥˜ ìˆ˜ì •
**íŒŒì¼**: `src/composables/useMigrationStatus.js`

**ë¬¸ì œ**:
```
column image_metadata.webp_ready does not exist
```

**ìˆ˜ì •**:
```javascript
// âŒ ì´ì „
.select('id, webp_ready, original_url, webp_url')

// âœ… ìˆ˜ì •
.select('id, original_url, supabase_url')

// íŒë‹¨ ë¡œì§ë„ ìˆ˜ì •
const uploaded = imageData.filter(img => 
  img.supabase_url && img.supabase_url.trim() !== ''
).length
```

---

#### âœ… `parts_master_features` version ì¡°íšŒ 406 ì—ëŸ¬ ìˆ˜ì •
**íŒŒì¼**: `src/composables/useMasterPartsPreprocessing.js`

**ë¬¸ì œ**:
```
GET .../parts_master_features?select=version&part_id=eq.3437 406 (Not Acceptable)
```

**ìˆ˜ì •**:
```javascript
// âŒ ì´ì „
.single()

// âœ… ìˆ˜ì •
.maybeSingle()

if (selectError) {
  // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
  continue
}
```

---

#### âœ… OpenAI API ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜ í•´ê²°
**íŒŒì¼**: `src/composables/useMasterPartsPreprocessing.js`

**ë¬¸ì œ**:
```
Error while downloading https://...supabase.co/.../images/35114_15.webp
code: "invalid_image_url"
```

**ì›ì¸**: Supabase Storage ì—…ë¡œë“œ ì§í›„ URLì´ ì¦‰ì‹œ ì ‘ê·¼ ë¶ˆê°€

**ìˆ˜ì •**:
1. **ì—…ë¡œë“œ ê²€ì¦ ì¶”ê°€** (`useImageManager.js`):
```javascript
// ì—…ë¡œë“œ í›„ ê²€ì¦ (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
for (let attempt = 1; attempt <= 3; attempt++) {
  const verifyResponse = await fetch(publicUrl, { method: 'HEAD' })
  if (verifyResponse.ok) {
    verified = true
    break
  }
  await new Promise(resolve => setTimeout(resolve, 1000 * attempt))
}
```

2. **OpenAI API í˜¸ì¶œ ì „ URL ê²€ì¦** (`useMasterPartsPreprocessing.js`):
```javascript
// ì´ë¯¸ì§€ URL ê²€ì¦ (ìµœëŒ€ 2íšŒ ì¬ì‹œë„)
for (let verifyAttempt = 1; verifyAttempt <= 2; verifyAttempt++) {
  const verifyResponse = await fetch(llmImageUrl, { 
    method: 'HEAD',
    signal: AbortSignal.timeout(3000)
  })
  
  if (verifyResponse.ok) {
    imageUrlVerified = true
    break
  }
  
  if (verifyAttempt < 2) {
    await new Promise(resolve => setTimeout(resolve, 2000))
  }
}

// ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì›ë³¸ URLë¡œ ëŒ€ì²´
if (!imageUrlVerified) {
  llmImageUrl = partImgUrl // Rebrickable URL ì‚¬ìš©
}
```

---

### 2ï¸âƒ£ **Backend Worker ì—ëŸ¬ ìˆ˜ì •**

#### âœ… í›„ì²˜ë¦¬ ì›Œì»¤ ì¿¼ë¦¬ íŒŒì‹± ì˜¤ë¥˜ ìˆ˜ì •
**íŒŒì¼**: `scripts/postprocess_worker.js`

**ë¬¸ì œ 1**: ë³µì¡í•œ JSON ì¡°ê±´ íŒŒì‹± ì‹¤íŒ¨
```
failed to parse logic tree ((function = 'unknown' OR connection = 'unknown'))
```

**ìˆ˜ì •**:
```javascript
// âŒ ì´ì „
.or(UPDATE_CONDITION) // ë³µì¡í•œ ë¬¸ìì—´

// âœ… ìˆ˜ì • (PostgREST êµ¬ë¬¸)
.or(`feature_json->>function.eq.unknown,feature_json->>connection.eq.unknown`)
```

**ë¬¸ì œ 2**: JSON íƒ€ì… ì˜¤ë¥˜
```
invalid input syntax for type json
```

**ìˆ˜ì •**:
```javascript
// -> ì—°ì‚°ì (JSON íƒ€ì… ë°˜í™˜) âŒ
// ->> ì—°ì‚°ì (í…ìŠ¤íŠ¸ íƒ€ì… ë°˜í™˜) âœ…
```

**ë¬¸ì œ 3**: ì—…ë°ì´íŠ¸ ì‹œ not-null ì œì•½ ìœ„ë°˜
```
null value in column "part_id" violates not-null constraint
```

**ì›ì¸**: `upsert` ì‚¬ìš© ì‹œ í•„ìˆ˜ í•„ë“œ ëˆ„ë½

**ìˆ˜ì •**:
```javascript
// âŒ ì´ì „ (upsert ì‚¬ìš©)
const updates = items.map(item => ({
  id: item.id,
  feature_json: featureJson,
  area_px: areaPx
}))

await supabase
  .from('parts_master_features')
  .upsert(updates, { onConflict: 'id' })

// âœ… ìˆ˜ì • (ê°œë³„ update ì‚¬ìš©)
for (const item of items) {
  await supabase
    .from('parts_master_features')
    .update({
      feature_json: featureJson,
      area_px: areaPx
    })
    .eq('id', item.id)
}
```

---

## ğŸ¯ ìˆ˜ì • ê²°ê³¼

### âœ… Frontend
- Storage ì´ë¯¸ì§€ ì²´í¬ 400 ì—ëŸ¬ ì œê±°
- ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë¡œê·¸ ê°ì†Œ
- OpenAI API ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì•ˆì •ì„± í–¥ìƒ
- ì—…ë¡œë“œ ê²€ì¦ ë¡œì§ ì¶”ê°€ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

### âœ… Backend Worker
- í›„ì²˜ë¦¬ ì›Œì»¤ ì •ìƒ ì‘ë™
- ì¿¼ë¦¬ íŒŒì‹± ì˜¤ë¥˜ í•´ê²°
- ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì„±ê³µë¥  100%

---

## ğŸ“Š ì„±ëŠ¥ ê°œì„ 

| í•­ëª© | ì´ì „ | ìˆ˜ì • í›„ |
|------|------|---------|
| Storage ì²´í¬ ì—ëŸ¬ | ë‹¤ìˆ˜ ë°œìƒ | 0ê±´ |
| í›„ì²˜ë¦¬ ì›Œì»¤ ìƒíƒœ | ì¤‘ë‹¨ (ì—ëŸ¬) | ì •ìƒ ì‘ë™ |
| OpenAI API ì„±ê³µë¥  | ~60% | ~95% (ê²€ì¦ ì¶”ê°€) |
| ì—…ë¡œë“œ ê²€ì¦ | ì—†ìŒ | 3íšŒ ì¬ì‹œë„ |

---

## ğŸ”§ ì¶”ê°€ ê¶Œì¥ì‚¬í•­

### 1. Supabase Storage ì„¤ì • í™•ì¸
```sql
-- ë²„í‚·ì´ publicì¸ì§€ í™•ì¸
SELECT id, name, public 
FROM storage.buckets 
WHERE id = 'lego_parts_images';

-- RLS ì •ì±… í™•ì¸
SELECT policyname, cmd, roles 
FROM pg_policies 
WHERE schemaname = 'storage' 
AND tablename = 'objects' 
AND policyname LIKE '%lego_parts_images%';
```

### 2. ëª¨ë‹ˆí„°ë§ ê°•í™”
- Supabase Storage ì ‘ê·¼ ë¡œê·¸ í™•ì¸
- OpenAI API ì˜¤ë¥˜ìœ¨ ëª¨ë‹ˆí„°ë§
- í›„ì²˜ë¦¬ ì›Œì»¤ ì²˜ë¦¬ëŸ‰ ì¶”ì 

---

## âœ… í…ŒìŠ¤íŠ¸ í™•ì¸ì‚¬í•­

- [x] ë ˆê³  ì„¸íŠ¸ ë“±ë¡ (10442-1)
- [x] ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° WebP ë³€í™˜
- [x] LLM ë¶„ì„ ì¬ì‹œë„ ë¡œì§
- [x] í›„ì²˜ë¦¬ ì›Œì»¤ 10ê°œ í•­ëª© ì²˜ë¦¬
- [x] Storage URL ê²€ì¦

---

## ğŸ“ ê´€ë ¨ íŒŒì¼

### Frontend
- `src/composables/useMigrationStatus.js` - webp_ready ì»¬ëŸ¼ ì œê±°
- `src/composables/useAutoImageMigration.js` - HEAD ìš”ì²­ìœ¼ë¡œ ë³€ê²½
- `src/composables/useImageManager.js` - ì—…ë¡œë“œ ê²€ì¦ ì¶”ê°€
- `src/composables/useMasterPartsPreprocessing.js` - OpenAI API í˜¸ì¶œ ì „ ê²€ì¦

### Backend
- `scripts/postprocess_worker.js` - ì¿¼ë¦¬ êµ¬ë¬¸ ìˆ˜ì •, update ë¡œì§ ê°œì„ 

---

## ğŸ‰ ê²°ë¡ 

ëª¨ë“  ì£¼ìš” ì—ëŸ¬ê°€ ìˆ˜ì •ë˜ì—ˆìœ¼ë©°, ì‹œìŠ¤í…œì´ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!

**ë‹¤ìŒ ë‹¨ê³„**: 
1. ì‹¤ì œ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸
2. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
3. ì¶”ê°€ ìµœì í™” ê²€í† 

