# ðŸ”§ ë©”íƒ€ë°ì´í„° ìžë™ ë™ê¸°í™” ë§¤í•‘ ê·œì¹™ ê°œì„  ì œì•ˆì„œ

**ìž‘ì„±ì¼**: 2025-10-13  
**ì‹¬ê°ë„**: ðŸ”´ CRITICAL  
**ì˜ˆìƒ ìž‘ì—… ì‹œê°„**: 2-3ì‹œê°„

---

## ðŸ“Š í˜„ìž¬ ë¬¸ì œ ìš”ì•½

### 1. CHECK ì œì•½ ìœ„ë°˜ (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
- `animal_figure` (8), `plant_leaf` (9)ê°€ ì½”ë“œì—ì„œ ì‚¬ìš© ì¤‘
- DB ì œì•½: `CHECK (part_category >= 0 AND <= 7)`
- **ê²°ê³¼**: ì´ ì¹´í…Œê³ ë¦¬ë“¤ì€ ì €ìž¥ ì‹œ **DB ì—ëŸ¬ ë°œìƒ**

### 2. ë§¤í•‘ ë¶ˆì¼ì¹˜ (3ê°€ì§€ ë‹¤ë¥¸ ì²´ê³„)
- ì½”ë“œ: 0-9 (10ê°œ)
- SQL: 0-7 (8ê°œ)
- ë¬¸ì„œ: 1-12, 99 (13ê°œ)

### 3. í™•ìž¥ì„± ë¶€ì¡±
- í•˜ë“œì½”ë”©ëœ ë§¤í•‘
- ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹œ ì½”ë“œ + DB + ë¬¸ì„œ ëª¨ë‘ ìˆ˜ì • í•„ìš”
- 20-30ê°œ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬ í•„ìš” ê°€ëŠ¥ì„±

---

## âœ… ê¶Œìž¥ í•´ê²° ë°©ì•ˆ (Option A - ìµœê³  ìš°ì„ ìˆœìœ„)

### **Step 1: part_categories Enum í…Œì´ë¸” ìƒì„±** (í™•ìž¥ì„± + ì •ê·œí™”)

#### 1.1 í…Œì´ë¸” ìƒì„±
```sql
-- database/create_part_categories_table.sql

-- ë¶€í’ˆ ì¹´í…Œê³ ë¦¬ Enum í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS part_categories (
  id INTEGER PRIMARY KEY,
  code VARCHAR(30) UNIQUE NOT NULL,        -- ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” í‚¤
  display_name VARCHAR(50) NOT NULL,       -- í‘œì‹œëª…
  description TEXT,                        -- ì„¤ëª…
  category_type VARCHAR(20) DEFAULT 'shape', -- 'shape' | 'series'
  parent_id INTEGER REFERENCES part_categories(id), -- ê³„ì¸µ êµ¬ì¡° ì§€ì›
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ê¸°ë³¸ shape ì¹´í…Œê³ ë¦¬ (í˜•íƒœ ë¶„ë¥˜)
INSERT INTO part_categories (id, code, display_name, description, category_type, sort_order) VALUES
(1, 'plate', 'Plate', 'í‰í‰í•œ í”Œë ˆì´íŠ¸', 'shape', 1),
(2, 'brick', 'Brick', 'ê¸°ë³¸ ë¸Œë¦­', 'shape', 2),
(3, 'tile', 'Tile', 'ìŠ¤í„°ë“œ ì—†ëŠ” íƒ€ì¼', 'shape', 3),
(4, 'slope', 'Slope', 'ê²½ì‚¬ ë¶€í’ˆ', 'shape', 4),
(5, 'panel', 'Panel', 'íŒ¨ë„ ë¶€í’ˆ', 'shape', 5),
(6, 'wedge', 'Wedge', 'ìê¸° ë¶€í’ˆ', 'shape', 6),
(7, 'cylinder', 'Cylinder', 'ì›ê¸°ë‘¥ ë¶€í’ˆ', 'shape', 7),
(8, 'cone', 'Cone', 'ì›ë¿” ë¶€í’ˆ', 'shape', 8),
(9, 'arch', 'Arch', 'ì•„ì¹˜ ë¶€í’ˆ', 'shape', 9),
(10, 'round', 'Round', 'ë‘¥ê·¼ ë¶€í’ˆ', 'shape', 10),
(11, 'dish', 'Dish', 'ì ‘ì‹œ ë¶€í’ˆ', 'shape', 11),
(12, 'hinge', 'Hinge', 'ížŒì§€ ë¶€í’ˆ', 'shape', 12),
(13, 'clip', 'Clip', 'í´ë¦½ ë¶€í’ˆ', 'shape', 13),
(14, 'bar', 'Bar', 'ë°” ë¶€í’ˆ', 'shape', 14),

-- íŠ¹ìˆ˜ ì¹´í…Œê³ ë¦¬
(20, 'minifig_part', 'Minifig Part', 'ë¯¸ë‹ˆí”¼ê·œì–´ ë¶€í’ˆ', 'shape', 20),
(21, 'animal_figure', 'Animal Figure', 'ë™ë¬¼ í”¼ê·œì–´', 'shape', 21),
(22, 'plant_leaf', 'Plant/Leaf', 'ì‹ë¬¼/ìžŽ ë¶€í’ˆ', 'shape', 22),
(23, 'wheel', 'Wheel', 'ë°”í€´ ë¶€í’ˆ', 'shape', 23),
(24, 'tire', 'Tire', 'íƒ€ì´ì–´ ë¶€í’ˆ', 'shape', 24),

-- ë¯¸ëž˜ í™•ìž¥ ì—¬ìœ 
-- (25-89: ì¶”ê°€ shape ì¹´í…Œê³ ë¦¬)

-- íŠ¹ìˆ˜ ê°’
(99, 'unknown', 'Unknown', 'ë¶„ë¥˜ë˜ì§€ ì•ŠìŒ', 'shape', 999);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_part_categories_code ON part_categories(code);
CREATE INDEX idx_part_categories_type ON part_categories(category_type);
CREATE INDEX idx_part_categories_active ON part_categories(is_active);
CREATE INDEX idx_part_categories_sort ON part_categories(sort_order);

-- ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION update_part_categories_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER part_categories_update_trigger
BEFORE UPDATE ON part_categories
FOR EACH ROW
EXECUTE FUNCTION update_part_categories_timestamp();

-- í†µê³„ ë·°
CREATE OR REPLACE VIEW v_part_categories_stats AS
SELECT 
  pc.id,
  pc.code,
  pc.display_name,
  pc.category_type,
  COUNT(pmf.id) as part_count,
  AVG(pmf.confidence) as avg_confidence
FROM part_categories pc
LEFT JOIN parts_master_features pmf ON pmf.part_category = pc.id
WHERE pc.is_active = TRUE
GROUP BY pc.id, pc.code, pc.display_name, pc.category_type
ORDER BY pc.sort_order;
```

#### 1.2 CHECK ì œì•½ ì œê±°
```sql
-- database/fix_part_category_constraint.sql

-- ê¸°ì¡´ CHECK ì œì•½ ì œê±° (0-7 ì œí•œ í•´ì œ)
ALTER TABLE parts_master_features
DROP CONSTRAINT IF EXISTS chk_part_category;

-- Foreign Key ì¶”ê°€
ALTER TABLE parts_master_features
ADD CONSTRAINT fk_part_category
FOREIGN KEY (part_category) 
REFERENCES part_categories(id)
ON DELETE SET NULL;

-- ì¸ë±ìŠ¤ (ì´ë¯¸ ìžˆìœ¼ë©´ ìŠ¤í‚µ)
CREATE INDEX IF NOT EXISTS idx_parts_master_features_part_category 
ON parts_master_features(part_category);
```

#### 1.3 íŽ¸ì˜ ë·° ìƒì„±
```sql
-- ë¶€í’ˆê³¼ ì¹´í…Œê³ ë¦¬ JOIN ë·°
CREATE OR REPLACE VIEW v_parts_with_category AS
SELECT 
  pmf.*,
  pc.code as category_code,
  pc.display_name as category_name,
  pc.category_type,
  pc.description as category_description
FROM parts_master_features pmf
LEFT JOIN part_categories pc ON pmf.part_category = pc.id;
```

---

### **Step 2: ì½”ë“œ ë§¤í•‘ í•¨ìˆ˜ ì—…ë°ì´íŠ¸**

#### 2.1 ë™ì  ë§¤í•‘ í•¨ìˆ˜ë¡œ ì „í™˜
```javascript
// src/composables/useMasterPartsPreprocessing.js

// âœ… ê°œì„ ëœ ë§¤í•‘ í•¨ìˆ˜ (DB ê¸°ë°˜ ë™ì  ë¡œë“œ)
let categoryMappingCache = null;

async function loadCategoryMapping() {
  if (categoryMappingCache) return categoryMappingCache;
  
  try {
    const { data, error } = await supabase
      .from('part_categories')
      .select('id, code')
      .eq('is_active', true);
    
    if (error) throw error;
    
    // ìºì‹œ ìƒì„±
    categoryMappingCache = {};
    data.forEach(cat => {
      categoryMappingCache[cat.code] = cat.id;
    });
    
    console.log('âœ… ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ë¡œë“œ ì™„ë£Œ:', Object.keys(categoryMappingCache).length, 'ê°œ');
    return categoryMappingCache;
  } catch (err) {
    console.error('âŒ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ë¡œë“œ ì‹¤íŒ¨:', err);
    // í´ë°±: í•˜ë“œì½”ë”©ëœ ë§¤í•‘
    return getHardcodedCategoryMapping();
  }
}

// âœ… í´ë°±ìš© í•˜ë“œì½”ë”© ë§¤í•‘ (DB ì—°ê²° ì‹¤íŒ¨ ì‹œ)
function getHardcodedCategoryMapping() {
  return {
    'plate': 1,
    'brick': 2, 
    'tile': 3,
    'slope': 4,
    'panel': 5,
    'wedge': 6,
    'cylinder': 7,
    'cone': 8,
    'arch': 9,
    'round': 10,
    'dish': 11,
    'hinge': 12,
    'clip': 13,
    'bar': 14,
    'minifig_part': 20,
    'animal_figure': 21,
    'plant_leaf': 22,
    'wheel': 23,
    'tire': 24,
    'unknown': 99
  };
}

// âœ… ê°œì„ ëœ getPartCategoryCode (ë™ì  + í´ë°±)
async function getPartCategoryCode(shapeTag) {
  const mapping = await loadCategoryMapping();
  const categoryId = mapping[shapeTag] || mapping['unknown'] || 99;
  
  // ë§¤í•‘ë˜ì§€ ì•Šì€ ì¹´í…Œê³ ë¦¬ ìžë™ ë“±ë¡ (ì„ íƒì‚¬í•­)
  if (!mapping[shapeTag] && shapeTag !== 'unknown') {
    console.warn(`âš ï¸ ë§¤í•‘ë˜ì§€ ì•Šì€ ì¹´í…Œê³ ë¦¬: ${shapeTag} â†’ unknown(99)ë¡œ í´ë°±`);
    // TODO: ìžë™ ë“±ë¡ ë¡œì§ (ê´€ë¦¬ìž ìŠ¹ì¸ í•„ìš” ì‹œ pending í…Œì´ë¸”ì— ì¶”ê°€)
  }
  
  return categoryId;
}

// âœ… ë™ê¸° ë²„ì „ (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„± ìœ ì§€)
function getPartCategoryCodeSync(shapeTag) {
  if (categoryMappingCache) {
    return categoryMappingCache[shapeTag] || categoryMappingCache['unknown'] || 99;
  }
  // ìºì‹œ ì—†ìœ¼ë©´ í•˜ë“œì½”ë”© ì‚¬ìš©
  const mapping = getHardcodedCategoryMapping();
  return mapping[shapeTag] || 99;
}
```

#### 2.2 ì´ˆê¸°í™” ì‹œ ìºì‹œ ë¡œë“œ
```javascript
// src/composables/useMasterPartsPreprocessing.js

export function useMasterPartsPreprocessing() {
  // ì´ˆê¸°í™” ì‹œ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ë¡œë“œ
  onMounted(async () => {
    await loadCategoryMapping();
  });
  
  // ... ê¸°ì¡´ ì½”ë“œ
}
```

---

### **Step 3: shape_tagì™€ series ì—­í•  ëª…í™•í™”**

#### 3.1 ê°œë… ë¶„ë¦¬
```javascript
// shape_tag: í˜•íƒœ ë¶„ë¥˜ (ë¬¼ë¦¬ì  í˜•ìƒ)
// - plate, brick, tile, slope, wedge, arch, cylinder, cone...
// - í•˜ë‚˜ì˜ ë¶€í’ˆì€ í•˜ë‚˜ì˜ shape_tagë§Œ ê°€ì§

// series: ì‹œë¦¬ì¦ˆ ë¶„ë¥˜ (ì œí’ˆêµ°)
// - system (ì¼ë°˜ ë ˆê³ ), duplo (ë“€í”Œë¡œ), technic (í…Œí¬ë‹‰), bionicle...
// - shape_tagì™€ ë…ë¦½ì 

// âŒ ìž˜ëª»ëœ ì‚¬ìš© (í˜„ìž¬)
duplo: 7  // part_categoryë¡œ ë§¤í•‘ (shapeê°€ ì•„ë‹˜!)

// âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš© (ê°œì„ )
shape_tag: 'brick'  // í˜•íƒœëŠ” brick
series: 'duplo'     // ì‹œë¦¬ì¦ˆëŠ” duplo
part_category: 2    // brickì˜ category ID
```

#### 3.2 getPartCategoryCode ìˆ˜ì •
```javascript
// âŒ ì œê±°: duplo, technic, minifigëŠ” part_categoryì—ì„œ ì œì™¸
// ì´ë“¤ì€ series í•„ë“œë¡œë§Œ ê´€ë¦¬

function getPartCategoryCode(shapeTag) {
  const mapping = {
    'plate': 1,
    'brick': 2, 
    'tile': 3,
    'slope': 4,
    // 'technic': 5,   // âŒ ì œê±° (seriesë¡œ ì´ë™)
    // 'minifig': 6,   // âŒ ì œê±° (minifig_part: 20ìœ¼ë¡œ ë³€ê²½)
    // 'duplo': 7,     // âŒ ì œê±° (seriesë¡œ ì´ë™)
    'animal_figure': 21,  // âœ… 8 â†’ 21 (CHECK ì œì•½ í•´ì œë¨)
    'plant_leaf': 22,     // âœ… 9 â†’ 22
    'unknown': 99         // âœ… 0 â†’ 99 (ì¼ê´€ì„±)
  }
  return mapping[shapeTag] || 99
}
```

---

## ðŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### Phase 1: DB ìŠ¤í‚¤ë§ˆ ìˆ˜ì • (ì¦‰ì‹œ)
```bash
# 1. ì¹´í…Œê³ ë¦¬ í…Œì´ë¸” ìƒì„±
psql -f database/create_part_categories_table.sql

# 2. CHECK ì œì•½ ì œê±° ë° Foreign Key ì¶”ê°€
psql -f database/fix_part_category_constraint.sql

# 3. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
psql -f database/migrate_part_categories.sql
```

### Phase 2: ì½”ë“œ ì—…ë°ì´íŠ¸ (1ì‹œê°„ ë‚´)
1. `useMasterPartsPreprocessing.js` ìˆ˜ì •
   - `loadCategoryMapping()` ì¶”ê°€
   - `getPartCategoryCode()` ì—…ë°ì´íŠ¸
   - `getHardcodedCategoryMapping()` ì¶”ê°€

2. series/shape_tag ë¶„ë¦¬
   - duplo, technic â†’ series only
   - animal_figure, plant_leaf â†’ 21, 22ë¡œ ë³€ê²½

### Phase 3: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (30ë¶„)
```javascript
// í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
const testCases = [
  { shape_tag: 'plate', expected: 1 },
  { shape_tag: 'animal_figure', expected: 21 },
  { shape_tag: 'plant_leaf', expected: 22 },
  { shape_tag: 'unknown', expected: 99 },
  { shape_tag: 'new_category', expected: 99 }, // í´ë°±
];
```

---

## ðŸŽ¯ ê¸°ëŒ€ íš¨ê³¼

### 1. ì¦‰ì‹œ íš¨ê³¼
âœ… CHECK ì œì•½ ìœ„ë°˜ í•´ê²° (animal_figure, plant_leaf ì €ìž¥ ê°€ëŠ¥)  
âœ… ë§¤í•‘ ë¶ˆì¼ì¹˜ í•´ì†Œ (ë‹¨ì¼ ì†ŒìŠ¤ ê´€ë¦¬)  
âœ… seriesì™€ shape_tag ì—­í•  ëª…í™•í™”  

### 2. ìž¥ê¸° íš¨ê³¼
âœ… **ë¬´í•œ í™•ìž¥ ê°€ëŠ¥**: ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹œ ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”  
âœ… **ìœ ì§€ë³´ìˆ˜ ìš©ì´**: DBì—ì„œ ì¤‘ì•™ ê´€ë¦¬  
âœ… **UI ìžë™í™”**: ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìžë™ ìƒì„±  
âœ… **í†µê³„/ë¶„ì„**: ì¹´í…Œê³ ë¦¬ë³„ ë¶€í’ˆ ìˆ˜, ì‹ ë¢°ë„ ë“± ì§‘ê³„ ê°€ëŠ¥  
âœ… **ë‹¤êµ­ì–´ ì§€ì›**: display_name_ko, display_name_en ì¶”ê°€ ê°€ëŠ¥  

### 3. ì„±ëŠ¥ ì˜í–¥
- **ì´ˆê¸° ë¡œë“œ**: +50ms (ìºì‹œ ë¡œë“œ)
- **ë§¤í•‘ ì¡°íšŒ**: 0ms (ìºì‹œ ì‚¬ìš©)
- **DB ì €ìž¥**: ë™ì¼ (Foreign KeyëŠ” ì¸ë±ìŠ¤ í™œìš©)

---

## ðŸ”„ ëŒ€ì•ˆ (Option B - ë¹ ë¥¸ ìˆ˜ì •)

ë§Œì•½ DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ì–´ë ¤ìš´ ê²½ìš°, **ìµœì†Œ ìˆ˜ì •ì•ˆ**:

### B-1. CHECK ì œì•½ë§Œ ìˆ˜ì •
```sql
-- CHECK ì œì•½ 0-7 â†’ 0-99ë¡œ í™•ìž¥
ALTER TABLE parts_master_features
DROP CONSTRAINT IF EXISTS chk_part_category;

ALTER TABLE parts_master_features
ADD CONSTRAINT chk_part_category
CHECK (part_category >= 0 AND part_category <= 99);
```

### B-2. ì½”ë“œ ë§¤í•‘ í†µì¼
```javascript
// ëª¨ë“  ê³³ì—ì„œ ë™ì¼í•œ ë§¤í•‘ ì‚¬ìš©
const CATEGORY_MAPPING = {
  'plate': 1, 'brick': 2, 'tile': 3, 'slope': 4,
  'panel': 5, 'wedge': 6, 'cylinder': 7, 'cone': 8,
  'arch': 9, 'round': 10, 'dish': 11, 'hinge': 12,
  'minifig_part': 20, 'animal_figure': 21, 'plant_leaf': 22,
  'unknown': 99
};
```

**ë‹¨ì **: ì—¬ì „ížˆ í•˜ë“œì½”ë”©, í™•ìž¥ì„± ì œí•œ

---

## âœ… ê¶Œìž¥ ê²°ì •

**Option A (Enum í…Œì´ë¸”)** ì„ íƒ ê¶Œìž¥:
- ì´ˆê¸° ìž‘ì—… ì‹œê°„: +1ì‹œê°„ (í…Œì´ë¸” ìƒì„±)
- ìž¥ê¸° ìœ ì§€ë³´ìˆ˜: **ëŒ€í­ ê°œì„ **
- í™•ìž¥ì„±: **ë¬´ì œí•œ**
- ROI: **ë§¤ìš° ë†’ìŒ**

---

## ðŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¦‰ì‹œ ì‹¤í–‰ (Critical)
- [ ] CHECK ì œì•½ ì œê±° (0-7 â†’ ë¬´ì œí•œ ë˜ëŠ” 0-99)
- [ ] `animal_figure`, `plant_leaf` ë§¤í•‘ ìˆ˜ì • (8,9 â†’ 21,22)
- [ ] ì½”ë“œ ë§¤í•‘ í†µì¼ (unknown: 0 â†’ 99)

### Phase 1 (ê¶Œìž¥, 2-3ì‹œê°„)
- [ ] part_categories í…Œì´ë¸” ìƒì„±
- [ ] Foreign Key ì¶”ê°€
- [ ] íŽ¸ì˜ ë·° ìƒì„±
- [ ] ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

### Phase 2 (ì½”ë“œ ê°œì„ )
- [ ] ë™ì  ë§¤í•‘ í•¨ìˆ˜ êµ¬í˜„
- [ ] series/shape_tag ì—­í•  ë¶„ë¦¬
- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìž‘ì„±

### Phase 3 (ë¬¸ì„œí™”)
- [ ] ë©”íƒ€ë°ì´í„°.txt ì—…ë°ì´íŠ¸
- [ ] ê¸°ìˆ ë¬¸ì„œ.txt ì—…ë°ì´íŠ¸
- [ ] README ì—…ë°ì´íŠ¸

---

**ìž‘ì„±ìž**: AI Assistant  
**ê²€í†  í•„ìš”**: ì‹œìŠ¤í…œ ì•„í‚¤í…íŠ¸, DB ê´€ë¦¬ìž, ë°±ì—”ë“œ ê°œë°œìž  
**ìŠ¹ì¸ í›„ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥**

