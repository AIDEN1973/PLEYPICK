# BrickBox 전체 검출 로직 검증 보고서

**검증 일시**: 2025년 10월 31일  
**문제점**: 부품이 없는데도 매칭되는 False Positive 발생

---

## 1. 전체 파이프라인 흐름

### 1.1 검출 파이프라인 단계

```
1. YOLO 검출 (Stage1 + Stage2)
   ↓
2. YOLO 필터링 (신뢰도 > 0.8, 상위 5개)
   ↓
3. AI 메타데이터 조회 (BOM 부품 대상)
   ↓
4. 폐쇄 환경 필터 적용 (BOM 부품만)
   ↓
5. BOM 기반 하이브리드 매칭
   ↓
6. 최종 결과
```

---

## 2. 각 단계별 검증

### 2.1 YOLO 검출 단계 ✅

**위치**: `src/composables/useOptimizedRealtimeDetection.js`

**검증 결과**:
- ✅ Stage1 검출 정상 작동
- ✅ Stage2 정밀 검증 정상 작동
- ✅ 중복 제거 (IoU 기반 NMS) 정상 작동

**문제점**: 없음

---

### 2.2 YOLO 필터링 단계 ✅

**위치**: `src/views/HybridDetection.vue` (라인 1908-1923)

**검증 결과**:
```javascript
// 신뢰도 > 0.8, 상위 5개만 선택
const filteredDetections = detections
  .filter(d => d.confidence > 0.8)
  .slice(0, 5)
```

**문제점**: 
- ❌ **검출 결과가 없을 때 전체 이미지를 하나의 객체로 처리** (라인 1925-1935)
- 이로 인해 실제 부품이 없어도 검출 객체가 생성됨

**수정 필요**:
- 검출 결과가 없으면 매칭 단계를 건너뛰어야 함

---

### 2.3 AI 메타데이터 조회 단계 ❌

**위치**: `src/views/HybridDetection.vue` (라인 3387-3456)

**검증 결과**:
```javascript
// BOM 부품 중 첫 번째를 무조건 반환
const bestMatch = data[0] // 임시: 우선순위가 높은 부품
```

**문제점**:
- ❌ **검출 객체와 실제 유사도를 확인하지 않음**
- ❌ **BOM 부품 중 첫 번째를 무조건 반환**
- 모든 검출 객체가 동일한 부품(32028)으로 인식됨

**수정 필요**:
- 검출 객체의 features와 각 BOM 부품의 벡터를 비교하여 가장 유사한 부품 선택
- 유사도가 임계값 이하면 null 반환

---

### 2.4 폐쇄 환경 필터 적용 단계 ⚠️

**위치**: `src/views/HybridDetection.vue` (라인 794-822)

**검증 결과**:
```javascript
// partsMetadata는 이미 BOM 부품들이므로 필터링이 필요 없음
return partsMetadata
```

**문제점**:
- ⚠️ **검출 객체를 필터링하지 않음**
- 검출 객체가 BOM에 없는 부품이어도 통과됨

**수정 필요**:
- 검출 객체의 part_id가 BOM에 있는지 확인
- BOM에 없는 검출 객체는 제외

---

### 2.5 BOM 기반 하이브리드 매칭 단계 ✅

**위치**: `src/views/HybridDetection.vue` (라인 825-1279)

**검증 결과**:
- ✅ 벡터 사전 로드 정상 작동
- ✅ 배치 병렬 처리 정상 작동
- ✅ FAISS Two-Stage 검색 정상 작동

**임계값 검증**:
- ✅ 벡터 유사도 ≥ 0.7 (엄격)
- ✅ YOLO 신뢰도 ≥ 0.7 (엄격)
- ✅ 최종 점수 ≥ 0.65 (엄격)
- ✅ combinedScore ≥ 0.7 (엄격)

**문제점**: 없음 (임계값은 엄격하게 설정됨)

---

## 3. 핵심 문제점 요약

### 3.1 심각한 문제 ❌

1. **AI 메타데이터 조회가 실제 유사도를 확인하지 않음**
   - 검출 객체와 BOM 부품의 벡터 비교 없음
   - BOM 부품 중 첫 번째를 무조건 반환
   - 결과: 모든 검출 객체가 동일한 부품으로 인식

2. **검출 결과가 없을 때 전체 이미지를 객체로 처리**
   - 실제 부품이 없어도 검출 객체가 생성됨
   - 결과: False Positive 발생

### 3.2 개선 필요 ⚠️

1. **폐쇄 환경 필터가 검출 객체를 필터링하지 않음**
   - BOM에 없는 검출 객체도 통과됨
   - 향후: 검출 객체의 part_id를 BOM과 비교하여 필터링

---

## 4. 수정 방안

### 4.1 즉시 수정 필요

#### 4.1.1 검출 결과 없을 때 처리 개선

```javascript
// 현재 (문제)
if (detections.length === 0) {
  detections = [전체 이미지를 객체로]
}

// 수정안
if (detections.length === 0) {
  console.log('⚠️ 검출 결과 없음, 매칭 단계 건너뜀')
  return { matches: [], missingSlots: bomMetadata.map(...) }
}
```

#### 4.1.2 AI 메타데이터 조회 개선

```javascript
// 현재 (문제)
const bestMatch = data[0] // 무조건 첫 번째

// 수정안
// 1. 검출 객체의 features와 각 BOM 부품의 벡터 비교
// 2. 가장 유사한 부품 선택
// 3. 유사도 < 0.7이면 null 반환
```

---

## 5. 수정 우선순위

1. **높음**: 검출 결과 없을 때 처리 개선
2. **높음**: AI 메타데이터 조회 시 실제 벡터 비교 추가
3. **중간**: 폐쇄 환경 필터가 검출 객체도 필터링하도록 개선

---

**검증 완료**: 2025년 10월 31일














