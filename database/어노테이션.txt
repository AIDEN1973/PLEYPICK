ğŸ§± BrickBox Annotation & JSON Specification v1.6.1 (Enhanced)

Date: 2025-10-11 Â· Author: BrickBox AI Lab Â· Schema Base: JSON Schema Draft 2020-12
Compatibility: 100% backward-compatible with v1.6 (ëª¨ë“  ì‹ ê·œ í•„ë“œëŠ” ì„ íƒ/ê¸°ë³¸ê°’ ì œê³µ)

0. ê°œìš” Â· ëª©ì  Â· ì„¤ê³„ ì›ì¹™ (ë³´ì™„ ë°˜ì˜)

ëª©ì : v1.6ì—ì„œ ì œì•ˆëœ ë³´ì™„ í•­ëª©(PnP Solver ë©”íƒ€ ëª…ì‹œ, Occlusion ìë™ ì‚°ì¶œ, Depth Map í’ˆì§ˆ ê²€ì¦, ì„±ëŠ¥ ë¡œê¹… ì„¸ë¶„í™”, ë³´ì•ˆ ë©”íƒ€/ì •ì±… ë¶„ë¦¬, Root Cause ë¶ˆí™•ì‹¤ì„±, SSS ì¬ì§ˆ ë¬¼ë¦¬, JSON-LD Export)ì„ ì •ì‹ ì‚¬ì–‘ìœ¼ë¡œ í¸ì…í•˜ì—¬ QA ìë™í™”Â·ìš´ì˜ ê°€ì‹œì„±Â·ë³´ì•ˆ ê±°ë²„ë„ŒìŠ¤ë¥¼ ê°•í™”í•œë‹¤.

í•µì‹¬ ì›ì¹™

Precision+3D QA: RMS reprojection, depth validation, occlusion attributionì˜ ì •ëŸ‰Â·ìë™ ê²€ì¦

Reproducibility: PnP solver íŒŒë¼ë¯¸í„°/ëœë¤ì‹œë“œ/í•˜ë“œì›¨ì–´/ë Œì¦ˆ ëª¨ë¸ ì™„ì „ ê¸°ë¡

Operational Efficiency: Edge-Essential ìµœì†Œí˜•, ì¶”ë¡  ì„±ëŠ¥ ì„¸ë¶„ ë¡œê¹…, Auto-Requeue ë° RLS ë³´ì•ˆ

Interoperability: ì„ íƒì  JSON-LD @context Exportë¡œ íƒ€ ì‚°ì—… í‘œì¤€ê³¼ ìƒí˜¸ìš´ìš©

1. ë°ì´í„° ë ˆì´ì•„ì›ƒ (ë¶€í’ˆ ë‹¨ìœ„ í´ë” êµ¬ì¡°)
/dataset_{SET_ID}/
â”œâ”€â”€ {element_id}/
â”‚   â”œâ”€â”€ images/{uuid}.png (ë˜ëŠ” .webp)
â”‚   â”œâ”€â”€ labels/{uuid}.txt
â”‚   â”œâ”€â”€ meta/{uuid}.json           # Full Meta (v1.6.1)
â”‚   â”œâ”€â”€ meta-e/{uuid}_e2.json      # Essential (v1.6.1-E2)
â”‚   â””â”€â”€ depth/{Blender ë„˜ë²„ë§}.exr  # Z-Depth (Blender ìë™ ë„˜ë²„ë§ ì‚¬ìš©)


ì¶”ê°€ ìš”êµ¬: meta/{uuid}.json ë‚´ ë³´ì•ˆ/ì ‘ê·¼ ë ˆë²¨ì€ ì§€í‘œìš©ë§Œ ê¸°ë¡. ì‹¤ì œ ì ‘ê·¼ì œì–´ëŠ” DB ì •ì±… í…Œì´ë¸”ì—ì„œ ì§‘í–‰(Â§8).

2. YOLO Segmentation Label (.txt) (ìœ ì§€ + Prompt ë©”íƒ€ í™•ì¥)
[prompt_token_id] class xc yc w h x1 y1 â€¦ xn yn


ì •ë°€ë„: ì†Œìˆ˜ 6ìë¦¬ ì´ìƒ(float32)

ì •ê·œí™” ê¸°ì¤€: í”„ë ˆì„(width, height)

í™•ì¥(ì„ íƒ): prompt_token_idì™€ í•¨ê»˜ prompt_metadataë¥¼ JSONì— ê¸°ë¡(Â§3.5)

3. Rendering Meta JSON (v1.6.1 ì˜ˆì‹œ â€” ë³´ì™„ í•„ë“œ í¬í•¨)
{
  "schema_version": "1.6.1",
  "pair_uid": "uuid-453601-199",
  "set_id": "76917",
  "element_id": "453601",
  "part_id": "4536",
  "class_map_version": "v2025-10-11-a",
  "image_size": [768, 768],  # ìµœì†Œ í•´ìƒë„ 768x768 (YOLO í•™ìŠµ ì…ë ¥ í¬ê¸° imgsz=768ê³¼ ì¼ì¹˜, ê¸°ìˆ ë¬¸ì„œ 2.4 ì¤€ìˆ˜)

  "class_id_mapping": { "4536": 12, "3001": 13, "3068b": 14 },
  "render_source": "auto_renderer_v5",
  "pipeline_version": "render_v5.1",
  "render_hardware": { "gpu": "RTX 4090", "cpu": "Ryzen 9 7950X", "render_engine": "Cycles-X" },
  "render_attempt_count": 3,

  "domain_context": {
    "domain_type": "LDraw/Blender",
    "lod_level": 3,
    "render_seed": 145623,
    "complexity_metric": {
      "occlusion_ratio": 0.42,
      "visible_surface_ratio": 0.58,
      "neighbor_parts": 5,
      "bbox_overlap_max": 0.37,
      "occluded_by_parts": ["3001", "3068b"],
      "occluder_contribution": { "3001": 0.25, "3068b": 0.17 }
    }
  },

  "annotation": {
    "bbox_pixel_xyxy": [156, 85, 549, 565],
    "bbox_norm_xywh": [0.550753, 0.507955, 0.615527, 0.750276],
    "bbox_norm_xyxy": [0.243, 0.133, 0.857, 0.883],
    "polygon_precision": 6,
    "polygon_frame_norm": [[0.243612, 0.191234] /* ... */],
    "segmentation": {
      "format": "rle_zstd_base64",
      "rle_base64": "iVBORw0KG...",
      "original_size": 409600,
      "compressed_size": 8432,
      "compression_ratio": 0.0206
    },
    "mask_dilation_px": 3,
    "mask_dilation_computation": {
      "method": "auto",
      "factors": [
        { "reason": "transparent_material", "contribution": 2 },
        { "reason": "low_contrast_background", "contribution": 2 }
      ],
      "capped_at": 5,
      "mask_dilation_px_final": 3
    },
    "quality": {
      "area_px": 24836,
      "perimeter_px": 657.8,
      "convexity": 0.93,
      "bbox_fill_ratio": 0.84
    },
    "quality_3d": {
      "pnp_method": "SOLVEPNP_SQPNP",
      "pnp_iterations": 300,
      "pnp_confidence": 0.999,
      "ransac_threshold_px": 2.0,
      "reprojection_error_rms_px": 1.25,
      "rotation_error_rad": 0.042,
      "translation_error_mm": 0.8,
      "z_depth_variance": 0.0025,
      "depth_map_validation": {
        "valid_pixel_ratio": 0.98,
        "out_of_range_pixels": 12,
        "edge_smoothness": 0.87,
        "depth_quality_score": 0.92,
        "method": "sobel+range+validity"
      },
      "depth_map_rle": "eJz7z8...",
      "depth_compression": "rle_zstd_base64"
    }
  },

  "camera": {
    "lens_mm": 50,
    "sensor_width_mm": 36,
    "intrinsics_3x3": [[640,0,320],[0,640,320],[0,0,1]],
    "distortion_model": "brown_conrady",
    "distortion_coeffs": { "k1": 0.01, "k2": -0.002, "p1": 0.0005, "p2": -0.0003, "k3": 0.001 },
    "intrinsics_validation": {
      "method": "pinhole_model",
      "valid": false,
      "original_intrinsics": [[640,0,320],[0,640,320],[0,0,1]],
      "corrected_intrinsics": [[888.9,0,320],[0,888.9,320],[0,0,1]],
      "correction_applied": true,
      "error_px_before": 248.9,
      "error_px_after": 0.0
    },
    "rotation_euler": [1.35, 0.97, 2.84],
    "rotation_unit": "radian",
    "focus_distance": 0.6,
    "aperture_fstop": 5.6
  },

  "material": {
    "color_hex": "#FFFFFF",
    "lego_color_id": 1,
    "is_transparent": true,
    "is_reflective": true,
    "roughness": 0.05,
    "uv_map_info": {
      "has_uv": true,
      "texture_path": "textures/4536_diffuse.png",
      "uv_resolution": [768, 768],  # ìµœì†Œ í•´ìƒë„ 768x768 (ê¸°ìˆ ë¬¸ì„œ 2.4 ì¤€ìˆ˜)
      "pattern_type": "decal",
      "coverage_ratio": 0.83,
      "uv_distortion": 0.04,
      "seam_visibility": { "visible_seams": 2, "max_seam_gap_px": 1.2, "seam_quality": "acceptable" }
    },
    "enable_sss": false,
    "sss_radius": [1.0, 1.0, 1.0],
    "sss_scale": 0.1
  },

  "lighting": {
    "environment_map": "studio_soft.hdr",
    "hdr_intensity": 0.6,
    "ibl_strength": 0.6,
    "luminance_range": { "min_cd_m2": 0.05, "max_cd_m2": 1200, "normalized_factor": 0.87 },
    "lighting_setup": "three_point_classic"
  },

  "image_quality": { "ssim": 0.974, "snr": 38.5, "sharpness": 0.81, "noise_level": 0.12, "low_contrast_metric": 0.07 },

  "integrity": {
    "image_blake3": "0f3a...",
    "label_blake3": "94d8...",
    "json_blake3": "c4b1...",
    "qa_flag_hierarchy": {
      "category": "FAIL_QUALITY",
      "subcategory": "POSE_ERROR",
      "root_cause": "CAMERA_CALIBRATION_ERROR",
      "root_cause_pred": ["CAMERA_CALIBRATION_ERROR", "LOW_TEXTURE_CONTRAST", "MASK_INACCURACY"],
      "root_cause_confidence": 0.71,
      "uncertainty_score": 0.38,
      "suggested_rule_id": "RC_RULE_003",
      "suggested_action": "Re-estimate PnP with distortion coeffs"
    },
    "qa_flag": "WARN_UNCERTAIN_ROOT_CAUSE",
    "security_level": "internal",
    "access_group_hint": ["qa-team", "ml-core"],
    "validated_at": "2025-10-14T09:15:00Z"
  },

  "@context": "https://schema.brickbox.ai/v1.6/context.jsonld"
}

3.1 PnP Solver ë©”íƒ€ (ì‹ ê·œ)

quality_3d.pnp_method: SOLVEPNP_SQPNP(ê¸°ë³¸) / SOLVEPNP_EPNP / SOLVEPNP_ITERATIVE / SOLVEPNP_P3P

pnp_iterations, pnp_confidence, ransac_threshold_px ê¸°ë¡ â†’ í•™ìŠµ/QA/ì¬í˜„ì„± ì¼ì¹˜

3.2 Occlusion ìë™ ì‚°ì¶œ (ì‹ ê·œ)

occlusion_ratio, visible_surface_ratio, occluded_by_parts, occluder_contribution

ì›ë¦¬: (i) íŒŒíŠ¸ ë‹¨ë… ë Œë” ë§ˆìŠ¤í¬(ì´ìƒ ë§ˆìŠ¤í¬) vs ì‹¤ì œ ë§ˆìŠ¤í¬ ë¹„êµ, (ii) íƒ€ íŒŒíŠ¸ ë§ˆìŠ¤í¬ ì¤‘ì²© ë©´ì  ê¸°ì—¬ë„ ê³„ì‚°

3.3 Depth Map í’ˆì§ˆ ê²€ì¦ (ì‹ ê·œ)

depth_map_validation: valid_pixel_ratio, out_of_range_pixels, edge_smoothness, depth_quality_score, method

í•©ì„± ê¸°ì¤€: valid_pixel_ratio â‰¥ 0.95, depth_quality_score â‰¥ 0.85

3.4 Distortion ëª¨ë¸ (í™•ì¥)

camera.distortion_model: "brown_conrady" (ê¸°ë³¸) / "fisheye"

fisheye ì„ íƒ ì‹œ k4 ë“± ê³„ìˆ˜ í—ˆìš©

3.5 Prompt ë©”íƒ€ (ì„ íƒ)
"annotation": {
  "prompt_metadata": {
    "prompt_text": "A white LEGO brick 2x4 with studs",
    "prompt_token_ids": [49406, 320, 2119, 2356],
    "prompt_embedding_dim": 512,
    "clip_model": "openai/clip-vit-large-patch14"
  }
}

3.6 ë³´ì•ˆ ë©”íƒ€ (í‘œì‹œ ì „ìš©)

integrity.security_level: "public" | "internal" | "restricted"

integrity.access_group_hint: ì ‘ê·¼ ê·¸ë£¹ íŒíŠ¸(ì§‘í–‰ì€ DB ì •ì±…ìœ¼ë¡œ, Â§8)

4. Essential JSON (v1.6.1-E2, ê²½ëŸ‰í˜•)
{
  "schema_version": "1.6.1-E2",
  "pair_uid": "uuid-453601-199",
  "part_id": "4536",
  "annotation": {
    "bbox_pixel_xyxy": [156,85,549,565],
    "bbox_norm_xyxy": [0.243,0.133,0.857,0.883],
    "segmentation": { "rle_base64": "iVBORw0KG...", "compressed_size": 8432 }
  },
  "qa": {
    "qa_flag": "PASS",
    "reprojection_rms_px": 1.25
  },
  "perf": { "avg_confidence": 0.91, "avg_inference_time_ms": 4.8 },
  "integrity": { "validated_at": "2025-10-14T09:15:00Z" }
}


ëª©í‘œ ìš©ëŸ‰: 0.3â€“0.9 KB

Edge ìµœì í™”: ì¦‰ì‹œ ë°•ìŠ¤ ì¢Œí‘œÂ·ì„¸ê·¸Â·ê°„ë‹¨ í’ˆì§ˆ/ì„±ëŠ¥ ì§€í‘œ ì‚¬ìš© ê°€ëŠ¥

5. ì•Œê³ ë¦¬ì¦˜ ì‚¬ì–‘ (ì°¸ê³  êµ¬í˜„)
5.1 PnP Reprojection RMS (OpenCV)
def reprojection_rms_px(obj3d, img2d, K, dist, method=cv2.SOLVEPNP_SQPNP, iters=300, ransac_thresh=2.0):
    ok, rvec, tvec, inliers = cv2.solvePnPRansac(
        np.array(obj3d), np.array(img2d), K, dist,
        useExtrinsicGuess=False, iterationsCount=iters,
        reprojectionError=ransac_thresh, flags=method, confidence=0.999
    )
    proj,_ = cv2.projectPoints(obj3d, rvec, tvec, K, dist)
    err = np.linalg.norm(proj.reshape(-1,2) - img2d, axis=1)
    return float(np.sqrt((err**2).mean()))

5.2 Occlusion ìë™ ê³„ì‚°
def compute_occlusion(meta, part_mask, neighbor_masks, ideal_mask):
    occluded_area = np.sum(ideal_mask & (~part_mask))
    total_ideal   = np.sum(ideal_mask)
    occlusion_ratio = 0.0 if total_ideal == 0 else occluded_area / total_ideal

    contrib = {}
    for pid, m in neighbor_masks.items():
        overlap = np.sum((~part_mask) & ideal_mask & m)
        if overlap > 0: contrib[pid] = contrib.get(pid, 0) + overlap
    total_contrib = sum(contrib.values()) or 1
    occluder_contribution = {k: v/total_contrib for k, v in contrib.items()}

    visible_surface_ratio = 1.0 - occlusion_ratio
    return occlusion_ratio, visible_surface_ratio, list(occluder_contribution.keys()), occluder_contribution

5.3 Depth í’ˆì§ˆ ê²€ì¦
def validate_depth_map(depth, zmin, zmax):
    valid = np.isfinite(depth) & (depth > 0)
    valid_ratio = np.mean(valid)
    depth_var = float(np.var(depth[valid])) if np.any(valid) else 1e9

    sobelx = cv2.Sobel(depth.astype(np.float32), cv2.CV_32F, 1, 0)
    sobely = cv2.Sobel(depth.astype(np.float32), cv2.CV_32F, 0, 1)
    edge_strength = float(np.mean(np.sqrt(sobelx**2 + sobely**2)))
    edge_smoothness = 1.0 / (1.0 + edge_strength)

    out_of_range = int(np.sum((depth < zmin) | (depth > zmax)))
    # 0~1 ì •ê·œí™” ì¢…í•© ì ìˆ˜(ê°€ì¤‘ì¹˜ ì¡°ì • ê°€ëŠ¥)
    score = 0.4*valid_ratio + 0.3*(1.0/(1.0+depth_var)) + 0.3*edge_smoothness
    return dict(valid_pixel_ratio=valid_ratio, depth_variance=depth_var,
                out_of_range_pixels=out_of_range, edge_smoothness=edge_smoothness,
                depth_quality_score=float(score), method="sobel+range+validity")

5.4 Root Cause ì‹ ë¢°ë„/ë¶ˆí™•ì‹¤ì„±
def root_cause_metrics(probs_topk):
    # probs_topk: ì˜ˆ) [0.71, 0.18, 0.11]
    import math
    # ì—”íŠ¸ë¡œí”¼ë¥¼ 0~1ë¡œ ì •ê·œí™”(K=topk)
    K = len(probs_topk)
    entropy = -sum(p*math.log(p+1e-12) for p in probs_topk) / math.log(K)
    confidence = probs_topk[0]
    warn = (confidence < 0.65) or (entropy >= 0.9)
    return dict(root_cause_confidence=confidence, uncertainty_score=entropy,
                qa_flag="WARN_UNCERTAIN_ROOT_CAUSE" if warn else None)

6. í•™ìŠµ/ìš´ì˜ ê·œì¹™(ê°œì •)
êµ¬ë¶„	ê¸°ì¤€	ì„¤ëª…
í•™ìŠµ í¸ì…	qa_flag='PASS' AND ssim â‰¥ 0.96 AND snr â‰¥ 30 AND reprojection_rms â‰¤ 1.5 AND depth_quality_score â‰¥ 0.85	3D/Depth í’ˆì§ˆ í¬í•¨
ë‚œì´ë„ ê· í˜•	occlusion_ratio 3ë¶„ìœ„ ê· ë“± ìƒ˜í”Œë§	ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€ ê³ ë¥´ê²Œ
íŠ¹ìˆ˜ ì¬ì§ˆ ê°€ì¤‘ì¹˜	is_transparent OR is_reflective â‰¥ 25%	ëŒ€í‘œì„± í™•ë³´
Auto-Requeue	qa_flag LIKE 'FAIL_%' OR WARN_UNCERTAIN_ROOT_CAUSE	ì¬ë Œë”/ì¬ì£¼ì„ í ì‚½ì…
SSS ì ìš©	enable_sss=true AND low_contrast_metric â‰¥ 0.15	ì„ íƒì , ì„±ëŠ¥ ì˜í–¥ ê´€ë¦¬
7. ëª¨ë¸ ì„±ëŠ¥ ë¡œê¹…(ì„¸ë¶„í™”) ë° ë·°
7.1 DDL (ì‹ ê·œ í…Œì´ë¸”)
CREATE TABLE IF NOT EXISTS inference_results_detailed (
  id bigserial PRIMARY KEY,
  pair_uid text NOT NULL,
  part_id text NOT NULL,
  model_tag text NOT NULL,
  model_version text,
  -- ì„±ëŠ¥
  inference_time_ms numeric,
  preprocessing_time_ms numeric,
  postprocessing_time_ms numeric,
  -- í’ˆì§ˆ
  confidence numeric,
  iou_with_ground_truth numeric,
  bbox_error_px numeric,
  -- í•˜ë“œì›¨ì–´
  device_type text,          -- 'gpu' | 'cpu' | 'edge'
  gpu_memory_used_mb int,
  created_at timestamptz DEFAULT now(),
  CONSTRAINT fk_pair FOREIGN KEY (pair_uid)
    REFERENCES synthetic_dataset(pair_uid) ON DELETE CASCADE
);

CREATE VIEW v_model_performance_detail AS
SELECT
  model_tag,
  COALESCE(device_type, 'unknown') AS device_type,
  ROUND(AVG(confidence)::numeric, 4) AS avg_conf,
  ROUND(AVG(iou_with_ground_truth)::numeric, 4) AS avg_iou,
  ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY inference_time_ms)::numeric, 2) AS p50_ms,
  ROUND(PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY inference_time_ms)::numeric, 2) AS p90_ms,
  ROUND(PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY inference_time_ms)::numeric, 2) AS p99_ms
FROM inference_results_detailed
GROUP BY model_tag, COALESCE(device_type, 'unknown');

7.2 ê¸°ì¡´ ìš”ì•½ ë·°(í™•ì¥)
CREATE OR REPLACE VIEW v_qa_summary_extended AS
SELECT
  part_id,
  COUNT(*) AS total,
  COUNT(*) FILTER (WHERE COALESCE(metadata->'integrity'->>'qa_flag',
       metadata->'integrity'->'qa_flag_hierarchy'->>'category')='PASS') AS pass,
  COUNT(*) FILTER (WHERE COALESCE(metadata->'integrity'->>'qa_flag',
       metadata->'integrity'->'qa_flag_hierarchy'->>'category') LIKE 'FAIL%') AS fail,
  COUNT(*) FILTER (WHERE metadata->'integrity'->>'qa_flag'='WARN_UNCERTAIN_ROOT_CAUSE') AS warn_uncertain,
  ROUND(AVG((metadata->'image_quality'->>'ssim')::numeric),4) AS avg_ssim,
  ROUND(AVG((metadata->'image_quality'->>'snr')::numeric),2) AS avg_snr,
  ROUND(AVG((metadata->'annotation'->'quality_3d'->>'reprojection_error_rms_px')::numeric),3) AS avg_rms_px,
  ROUND(AVG((metadata->'annotation'->'quality_3d'->'depth_map_validation'->>'depth_quality_score')::numeric),3) AS avg_depth_quality
FROM synthetic_dataset GROUP BY part_id;

8. ë³´ì•ˆ ê±°ë²„ë„ŒìŠ¤(Access Control Meta & RLS ì •ì±…)

ì›ì¹™: ë©”íƒ€(security_level, access_group_hint)ëŠ” í‘œì‹œìš©. ì‹¤ì œ ê¶Œí•œì€ ì •ì±… í…Œì´ë¸”+RLSë¡œ ì§‘í–‰.

8.1 ì •ì±… í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS access_groups (
  id serial PRIMARY KEY,
  group_name text UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS admin_user_groups (
  admin_user_id uuid NOT NULL REFERENCES admin_users(id),
  group_id int NOT NULL REFERENCES access_groups(id),
  PRIMARY KEY (admin_user_id, group_id)
);

CREATE TABLE IF NOT EXISTS part_access_policies (
  part_id text NOT NULL,
  security_level text NOT NULL CHECK (security_level IN ('public','internal','restricted')),
  allowed_group_ids int[] NOT NULL DEFAULT '{}',
  PRIMARY KEY (part_id)
);

8.2 RLS í™œì„±í™” (ì˜ˆ: synthetic_dataset)
ALTER TABLE synthetic_dataset ENABLE ROW LEVEL SECURITY;

-- ê°„ë‹¨í•œ ì˜ˆ: restrictedëŠ” ê·¸ë£¹ í¬í•¨ ì‚¬ìš©ìë§Œ ì—´ëŒ
CREATE POLICY sd_read_policy ON synthetic_dataset
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM part_access_policies pap
    WHERE pap.part_id = synthetic_dataset.part_id
      AND (
        pap.security_level IN ('public','internal')  -- org-wide í—ˆìš©
        OR EXISTS (
          SELECT 1 FROM admin_user_groups aug
          WHERE aug.admin_user_id = auth.uid()
            AND aug.group_id = ANY(pap.allowed_group_ids)
        )
      )
  )
);


ì£¼: Supabase í™˜ê²½ì— ë§ì¶° auth.uid()/JWT í´ë ˆì„ ê¸°ë°˜ìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥.
ë©”íƒ€ì˜ security_levelê³¼ ì •ì±… í…Œì´ë¸”ì˜ ê°’ì€ ì£¼ê¸°ì  ë™ê¸°í™”(íŠ¸ë¦¬ê±°/ë°°ì¹˜) ê¶Œì¥.

9. JSON Schema ìš”ì•½ (ì¶”ê°€/ë³€ê²½ í•„ë“œ)
9.1 quality_3d (ì¶”ê°€)
{
  "type": "object",
  "properties": {
    "pnp_method": { "type": "string", "enum": ["SOLVEPNP_SQPNP","SOLVEPNP_EPNP","SOLVEPNP_ITERATIVE","SOLVEPNP_P3P"] },
    "pnp_iterations": { "type": "integer", "minimum": 1 },
    "pnp_confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "ransac_threshold_px": { "type": "number", "minimum": 0 },
    "reprojection_error_rms_px": { "type": "number", "minimum": 0 },
    "rotation_error_rad": { "type": "number", "minimum": 0 },
    "translation_error_mm": { "type": "number", "minimum": 0 },
    "z_depth_variance": { "type": "number", "minimum": 0 },
    "depth_map_validation": {
      "type": "object",
      "properties": {
        "valid_pixel_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
        "out_of_range_pixels": { "type": "integer", "minimum": 0 },
        "edge_smoothness": { "type": "number", "minimum": 0, "maximum": 1 },
        "depth_quality_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "method": { "type": "string" }
      },
      "required": ["valid_pixel_ratio","depth_quality_score"]
    }
  },
  "required": ["reprojection_error_rms_px"]
}

9.2 complexity_metric (í™•ì¥)
{
  "type": "object",
  "properties": {
    "occlusion_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
    "visible_surface_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
    "neighbor_parts": { "type": "integer", "minimum": 0 },
    "bbox_overlap_max": { "type": "number", "minimum": 0, "maximum": 1 },
    "occluded_by_parts": { "type": "array", "items": { "type": "string" } },
    "occluder_contribution": { "type": "object", "additionalProperties": { "type": "number" } }
  },
  "required": ["occlusion_ratio","visible_surface_ratio"]
}

9.3 camera (í™•ì¥)
{
  "type": "object",
  "properties": {
    "distortion_model": { "type": "string", "enum": ["brown_conrady","fisheye"] },
    "distortion_coeffs": { "type": "object", "additionalProperties": { "type": "number" } }
  }
}

9.4 integrity (í™•ì¥)
{
  "type": "object",
  "properties": {
    "qa_flag": { "type": "string" },
    "qa_flag_hierarchy": {
      "type": "object",
      "properties": {
        "root_cause_pred": { "type": "array", "items": { "type": "string" } },
        "root_cause_confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "uncertainty_score": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "security_level": { "type": "string", "enum": ["public","internal","restricted"] },
    "access_group_hint": { "type": "array", "items": { "type": "string" } }
  }
}

10. ë§ˆì´ê·¸ë ˆì´ì…˜ & í˜¸í™˜ì„±

Backward-compatible: v1.6 JSONì€ ê·¸ëŒ€ë¡œ ìœ íš¨. v1.6.1 ì‹ ê·œ í•„ë“œëŠ” ëª¨ë‘ ì„ íƒì´ë©° ê¸°ë³¸ê°’/ë¯¸ì¡´ì¬ ì‹œ íŒŒì´í”„ë¼ì¸ì´ ì•ˆì „í•˜ê²Œ ë™ì‘.

ê¶Œì¥ ë‹¨ê³„

ë Œë” íŒŒì´í”„ë¼ì¸ì— occlusion/depth validation ê³„ì‚° ì¶”ê°€

PnP solver ë©”íƒ€ ê¸°ë¡

Essential JSON E2ë¡œ Edge êµì²´

DB ìŠ¤í‚¤ë§ˆ(Â§7, Â§8) ì ìš© â†’ ë·°/ì •ì±… ì ê²€

11. í…ŒìŠ¤íŠ¸ & ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

 RMS â‰¤ 1.5 px, DepthScore â‰¥ 0.85, SSIM â‰¥ 0.96, SNR â‰¥ 30 â†’ PASS

 occlusion_ratio ë¶„ìœ„ ê· ë“± ë¶„í¬(ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)

 Root Cause: confidence â‰¥ 0.65 ë˜ëŠ” uncertainty < 0.9 â†’ í™•ì •, ì•„ë‹ˆë©´ WARN_UNCERTAIN

 RLS: restricted íŒŒíŠ¸ê°€ ë¯¸ì¸ê°€ ì‚¬ìš©ìì—ê²Œ ì°¨ë‹¨

 Edge: bbox_norm_xyxy ì§ì‚¬ìš©, 1000 bbox ë³€í™˜ ì‹œê°„ â‰¤ 1 ms (ì¥ì¹˜ ì˜ì¡´)

12. ìš´ì˜ íŒ & ê¶Œì¥ íŒŒë¼ë¯¸í„°

PnP: SOLVEPNP_SQPNP + ransac_threshold_px=2.0, iterations=300, confidence=0.999

Depth: ì†ŒìŠ¤ z-range ëª…ì‹œ(ì¹´ë©”ë¼-ì˜¤ë¸Œì íŠ¸ ê¸°ì¤€) â†’ out_of_range í”½ì…€ ìƒì‹œ ëª¨ë‹ˆí„°ë§

SSS: enable_sss=trueëŠ” low_contrast_metric â‰¥ 0.15 ë° íˆ¬ëª…/ë°˜ì‚¬ ì¬ì§ˆì— í•œì •

ë³´ì•ˆ: part_access_policiesëŠ” CI/CDì— í¬í•¨, PR ë¦¬ë·° í•„ìˆ˜

13. ê²°ë¡ 

v1.6.1ì€ v1.6ì˜ ê°•ì ì„ ìœ ì§€í•˜ë©´ì„œ (i) ìë™í™”ëœ 3D/Occlusion ê²€ì¦, (ii) ì‹¬í™”ëœ Depth í’ˆì§ˆ, (iii) ì„¸ë¶„í™”ëœ ì„±ëŠ¥ ë¡œê¹…, (iv) ì •ì±… ì£¼ë„ ë³´ì•ˆ, (v) Root Cause ë¶ˆí™•ì‹¤ì„± ëª¨ë¸ë§, (vi) ì„ íƒì  ë¬¼ë¦¬/í‘œì¤€ ë ˆì´ì–´ë¥¼ ì¶”ê°€í–ˆë‹¤.
â†’ BrickBoxëŠ” â€œë Œë”ë§ â†’ í•™ìŠµ â†’ QA â†’ ë°°í¬ â†’ ê±°ë²„ë„ŒìŠ¤â€ ì „ ê³¼ì •ì„ ì¬í˜„ ê°€ëŠ¥í•˜ê³  ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ í†µì œí•˜ëŠ” ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ 3D-Vision ë°ì´í„° í”„ë ˆì„ì›Œí¬ë¡œ ì™„ì„±ë˜ì—ˆë‹¤.

ë¶€ë¡ A. synthetic_dataset ì¸ë±ìŠ¤ ê¶Œì¥
CREATE INDEX IF NOT EXISTS idx_sd_part ON synthetic_dataset (part_id);
CREATE INDEX IF NOT EXISTS idx_sd_meta_qa ON synthetic_dataset USING GIN ((metadata->'integrity'));
CREATE INDEX IF NOT EXISTS idx_sd_meta_3d ON synthetic_dataset USING GIN ((metadata->'annotation'->'quality_3d'));

ë¶€ë¡ B. Auto-Requeue ì˜ˆì‹œ íŠ¸ë¦¬ê±°
CREATE TABLE IF NOT EXISTS render_queue (
  id bigserial PRIMARY KEY,
  pair_uid text, part_id text, reason text, created_at timestamptz DEFAULT now()
);

CREATE OR REPLACE FUNCTION enqueue_failed_samples()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
  IF (NEW.metadata->'integrity'->>'qa_flag') LIKE 'FAIL%' OR
     (NEW.metadata->'integrity'->>'qa_flag') = 'WARN_UNCERTAIN_ROOT_CAUSE' THEN
    INSERT INTO render_queue(pair_uid, part_id, reason)
    VALUES (NEW.pair_uid, NEW.part_id, COALESCE(NEW.metadata->'integrity'->>'qa_flag','WARN'));
  END IF;
  RETURN NEW;
END; $$;

DROP TRIGGER IF EXISTS trg_sd_autorequeue ON synthetic_dataset;
CREATE TRIGGER trg_sd_autorequeue
AFTER INSERT OR UPDATE ON synthetic_dataset
FOR EACH ROW EXECUTE FUNCTION enqueue_failed_samples();

# [AI Update] 2025-11-03 21:02:07 â€” meta-e/{element_id}/{uuid}\.json â†’ meta-e/{element_id}/{uuid}.json ë˜ëŠ” {uuid}_e2.json í—ˆìš©


# [AI Update] 2025-11-03 21:02:10 â€” depth/{element_id}/{uuid}\.bin â†’ depth/{element_id}/{uuid}.bin (.exr ì›ë³¸ ë³‘í–‰ ë³´ê´€ í—ˆìš©)

# [AI Update] 2025-11-04 â€” ë Œë”ë§ í•´ìƒë„ ìµœì†Œ ìš”êµ¬ì‚¬í•­: image_size [1024, 1024] â†’ [768, 768]
# - ê¸°ìˆ ë¬¸ì„œ 2.4 ì¤€ìˆ˜: ìµœì†Œ í•´ìƒë„ 768x768 ì´ìƒ
# - YOLO í•™ìŠµ ì…ë ¥ í¬ê¸° imgsz=768ê³¼ ì¼ì¹˜, ë‹¤ìš´ìƒ˜í”Œë§ ì œê±°ë¡œ í’ˆì§ˆ ìœ ì§€ ë° ì„±ëŠ¥ í–¥ìƒ
# - uv_resolutionë„ ë™ì¼í•˜ê²Œ 768x768ë¡œ ìˆ˜ì •
