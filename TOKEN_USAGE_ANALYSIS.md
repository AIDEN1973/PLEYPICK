# 💰 토큰 사용량 분석: 임베딩 자동화 vs 수동 처리

## 📊 토큰 사용량 비교

### **현재 설정 (자동화)**
```javascript
// API_LIMITS 설정
const API_LIMITS = {
  requestsPerMinute: 100,    // 100 RPM
  tokensPerMinute: 50000,    // 50K TPM
  maxConcurrent: 1,          // 동시 요청 1개
  requestDelay: 2000,        // 요청 간 2초 대기
  retryDelay: 5000,          // 재시도 시 5초 대기
  maxRetries: 2              // 최대 재시도 2회
}
```

### **모델별 비용 (1M 토큰 기준)**
```javascript
const costs = {
  'gpt-4o-mini': 0.00015,        // $0.15/1M 토큰 (1차)
  'gpt-5-mini': 0.0003,          // $0.30/1M 토큰 (2차)
  'gpt-4-turbo': 0.001,          // $1.00/1M 토큰 (3차)
  'gpt-4o': 0.0025,              // $2.50/1M 토큰 (4차)
}
```

---

## 🔍 토큰 사용량 분석

### **1. LLM 분석 (부품당)**

#### **입력 토큰 (프롬프트)**
```
평균 프롬프트 길이: ~2,000 토큰
- 시스템 프롬프트: ~500 토큰
- 부품 정보: ~800 토큰  
- 이미지 설명: ~700 토큰
```

#### **출력 토큰 (응답)**
```
평균 응답 길이: ~1,500 토큰
- feature_text: ~200 토큰
- function: ~50 토큰
- connection: ~50 토큰
- recognition_hints: ~1,200 토큰
```

#### **부품당 총 토큰**
```
입력: 2,000 토큰
출력: 1,500 토큰
총합: 3,500 토큰/부품
```

### **2. CLIP 임베딩 (부품당)**

#### **CLIP 서비스 사용 시**
```
토큰 사용량: 0 토큰
- 로컬 CLIP 모델 사용
- OpenAI API 호출 없음
- 비용: $0
```

#### **OpenAI 임베딩 사용 시**
```
입력: feature_text (~200 토큰)
출력: 768차원 벡터 (토큰 없음)
총합: 200 토큰/부품
```

---

## 💰 비용 계산

### **시나리오 1: CLIP 서비스 사용 (권장)**

| 부품 수 | LLM 토큰 | CLIP 토큰 | 총 토큰 | 비용 (gpt-4o-mini) |
|---------|----------|-----------|---------|-------------------|
| 10개    | 35,000   | 0         | 35,000  | $0.005           |
| 50개    | 175,000  | 0         | 175,000 | $0.026           |
| 100개   | 350,000  | 0         | 350,000 | $0.053           |
| 1,000개 | 3,500,000| 0         | 3,500,000| $0.53           |

### **시나리오 2: OpenAI 임베딩 사용**

| 부품 수 | LLM 토큰 | 임베딩 토큰 | 총 토큰 | 비용 (gpt-4o-mini) |
|---------|----------|-------------|---------|-------------------|
| 10개    | 35,000   | 2,000       | 37,000  | $0.006           |
| 50개    | 175,000  | 10,000      | 185,000 | $0.028           |
| 100개   | 350,000  | 20,000      | 370,000 | $0.056           |
| 1,000개 | 3,500,000| 200,000     | 3,700,000| $0.56           |

---

## 🚀 자동화 vs 수동 처리 비교

### **자동화 처리 (현재)**
```
✅ 장점:
- 사용자 개입 없음
- 일관된 품질
- 실수 방지
- 시간 절약

❌ 단점:
- 토큰 사용량 증가
- API 비용 증가
- Rate limit 위험
```

### **수동 처리**
```
✅ 장점:
- 토큰 사용량 최소화
- 비용 절약
- 세밀한 제어

❌ 단점:
- 사용자 개입 필요
- 시간 소요
- 실수 가능성
- 일관성 부족
```

---

## 📈 토큰 사용량 최적화 방안

### **1. 배치 처리 최적화**
```javascript
// 현재: 1개씩 처리
const BATCH_SIZE = 1

// 개선: 3-5개씩 배치 처리
const BATCH_SIZE = 3
```

### **2. 프롬프트 최적화**
```javascript
// 현재: 상세 프롬프트 (~2,000 토큰)
// 개선: 간소화된 프롬프트 (~1,000 토큰)
// 절약: 50% 토큰 감소
```

### **3. 모델 선택 최적화**
```javascript
// 1차: gpt-4o-mini ($0.15/1M) - 가장 저렴
// 2차: gpt-5-mini ($0.30/1M) - 성능 향상
// 3차: gpt-4-turbo ($1.00/1M) - 고품질
// 4차: gpt-4o ($2.50/1M) - 최고 품질
```

### **4. CLIP 서비스 우선 사용**
```javascript
// CLIP 서비스 사용 시 토큰 사용량: 0
// OpenAI 임베딩 사용 시 토큰 사용량: 200/부품
// 절약: 200 토큰/부품
```

---

## 🎯 권장 전략

### **소규모 (10-50개 부품)**
```
✅ 자동화 권장
- 비용: $0.005-0.028
- 시간 절약: 2-5분
- 품질: 일관됨
```

### **중규모 (50-200개 부품)**
```
⚠️ 선택적 자동화
- 비용: $0.028-0.11
- 배치 처리 권장
- CLIP 서비스 필수
```

### **대규모 (200개 이상)**
```
🔧 하이브리드 접근
- 중요 부품: 자동화
- 일반 부품: 수동 처리
- CLIP 서비스 필수
- 배치 크기 최적화
```

---

## 💡 비용 절약 팁

### **1. CLIP 서비스 사용**
```bash
# CLIP 서비스 실행 (토큰 사용량 0)
python server/clip-embedding-service.py
```

### **2. 배치 크기 조정**
```javascript
// API_LIMITS 조정
const API_LIMITS = {
  requestsPerMinute: 50,     // 100 → 50으로 감소
  tokensPerMinute: 25000,    // 50K → 25K로 감소
  requestDelay: 3000,        // 2초 → 3초로 증가
}
```

### **3. 프롬프트 최적화**
```javascript
// 상세 프롬프트 → 간소화된 프롬프트
// 토큰 사용량 50% 절약
```

---

## 📊 결론

### **토큰 사용량 증가: 예**
- **자동화 시**: 부품당 3,500 토큰 (LLM) + 0 토큰 (CLIP)
- **수동 처리 시**: 부품당 0 토큰

### **하지만 비용은 상대적으로 저렴**
- **100개 부품**: $0.053 (CLIP 서비스 사용 시)
- **1,000개 부품**: $0.53 (CLIP 서비스 사용 시)

### **권장사항**
1. **CLIP 서비스 사용** (토큰 사용량 0)
2. **배치 처리 최적화** (3-5개씩)
3. **프롬프트 최적화** (50% 절약)
4. **소규모는 자동화, 대규모는 하이브리드**

**결론: 토큰 사용량은 증가하지만, CLIP 서비스 사용 시 비용은 매우 저렴하며, 시간 절약과 품질 향상의 이점이 더 큽니다.**
