# 🔄 프롬프트 동기화 가이드

## 📋 개요

`useMasterPartsPreprocessing.js` 파일의 하드코딩된 프롬프트가 메타데이터 관리 UI의 프롬프트 편집 내용과 자동으로 동기화됩니다.

## 🔧 동작 원리

### 1. **DB 우선 로드**
```javascript
// useMasterPartsPreprocessing.js에서 자동으로 실행
globalUserConfig = await loadUserConfigFromDB()
```

### 2. **UI 편집 내용 자동 반영**
- `http://localhost:3000/metadata-management` > 프롬프트 편집에서 수정
- "✅ 설정 적용 및 배포" 클릭
- `metadata_prompt_configs` 테이블에 저장
- 다음 메타데이터 생성부터 자동 반영

### 3. **폴백 시스템**
- DB 로드 실패 시 → 로컬 캐시 사용
- 로컬 캐시 없음 → 기본 프롬프트 사용

## 🚀 사용 방법

### Step 1: 프롬프트 편집
1. `http://localhost:3000/metadata-management` 접속
2. "📝 프롬프트 편집" 탭 클릭
3. 원하는 프롬프트 수정:
   - **시스템 프롬프트**: AI 역할 정의
   - **메인 프롬프트**: 분석 지시사항
   - **필수 요구사항**: 검증 규칙

### Step 2: 설정 저장
1. "💾 설정 저장" 클릭
2. "✅ 설정 적용 및 배포" 클릭
3. 로컬 스토리지 + DB에 저장

### Step 3: 자동 반영 확인
- 새로운 부품 등록 시 수정된 프롬프트 사용
- 콘솔에서 "✅ DB 사용자 정의 프롬프트 사용 (UI 편집 내용 반영됨)" 확인

## 📊 프롬프트 구조

### 시스템 프롬프트
```
당신은 레고 부품 전문가입니다. 이미지를 분석하여 JSON 형식으로 응답하세요.
```

### 메인 프롬프트
```
레고 부품 정보:
- 부품명: ${partName}
- 부품 번호: ${partNum}
- 색상: ${colorName}

다음 JSON 형식으로 정확히 응답해주세요:
{
  "part_id": "${partNum}",
  "shape_tag": "아래 55개 옵션 중 하나 선택",
  // ... 기타 필드
}
```

### 필수 요구사항
```
- shape_tag: 위 55개 옵션 중 정확히 하나 선택
- series: 시리즈 분류 (기본값: "system")
- recognition_hints.ko: 반드시 20자 이상의 자연스러운 한국어 설명
// ... 기타 규칙
```

## 🔍 디버깅

### 프롬프트 로드 확인
```javascript
// 콘솔에서 확인 가능한 로그
✅ DB에서 사용자 설정 로드 완료 (UI 편집 내용 반영됨)
✅ DB 사용자 정의 프롬프트 사용 (UI 편집 내용 반영됨)
```

### 문제 해결
1. **DB 연결 실패**: 로컬 캐시 사용
2. **설정 없음**: 기본 프롬프트 사용
3. **변수 치환 실패**: `${partName}` 등 변수 확인

## 📝 주의사항

### 1. **변수 사용**
- `${partName}`: 부품명
- `${partNum}`: 부품 번호  
- `${colorName}`: 색상명

### 2. **JSON 형식 준수**
- 55개 shape_tag 옵션 중 하나만 선택
- 모든 배열은 `]`로 닫기
- 숫자 필드는 따옴표 없이 작성

### 3. **실시간 반영**
- UI에서 수정 후 "설정 적용 및 배포" 필수
- 다음 메타데이터 생성부터 반영
- 기존 데이터는 영향 없음

## 🎯 활용 예시

### 프롬프트 개선 시나리오
1. **feature_text 품질 향상**
   ```
   feature_text 생성 시 다음 규칙을 따르세요:
   - 부품번호 절대 포함 금지
   - 자연스러운 한국어 문장
   - 20자 이상 상세 설명
   ```

2. **shape_tag 정확도 향상**
   ```
   shape_tag 선택 시 다음을 고려하세요:
   - 부품의 주요 기능과 형태
   - 55개 옵션 중 가장 적합한 것
   - 애매한 경우 'unknown' 사용
   ```

3. **recognition_hints 개선**
   ```
   recognition_hints.ko 작성 시:
   - 구체적인 형태 설명
   - 색상과 크기 정보 포함
   - 20자 이상의 자연스러운 문장
   ```

이제 UI에서 프롬프트를 편집하면 자동으로 `useMasterPartsPreprocessing.js`에 반영됩니다!
