#!/usr/bin/env python3 """ Supabase Storageì˜ models ë²„í‚·ì— ìˆëŠ” ëª¨ë¸ íŒŒì¼ë“¤ì„ model_registryì— ë“±ë¡ """ import os import json from datetime import datetime from supabase import create_client, Client def load_env(): """í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ""" env_vars = {} try: with open('.env', 'r', encoding='utf-8') as f: for line in f: line = line.strip() if line and not line.startswith('#') and '=' in line: key, value = line.split('=', 1) env_vars[key] = value except FileNotFoundError: print(" .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.") return None return env_vars def get_supabase_client(): """Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±""" env_vars = load_env() if not env_vars: return None SUPABASE_URL = env_vars.get('VITE_SUPABASE_URL') SUPABASE_KEY = env_vars.get('VITE_SUPABASE_SERVICE_ROLE_KEY') or env_vars.get('VITE_SUPABASE_ANON_KEY') if not SUPABASE_URL or not SUPABASE_KEY: print(" Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.") return None return create_client(SUPABASE_URL, SUPABASE_KEY) def list_storage_models(supabase: Client): """Storageì˜ models ë²„í‚·ì—ì„œ ëª¨ë¸ íŒŒì¼ ëª©ë¡ ì¡°íšŒ""" try: # models ë²„í‚·ì˜ ëª¨ë“  íŒŒì¼ ì¡°íšŒ files = supabase.storage.from_('models').list() model_files = [] for file_info in files: if file_info.get('name'): name = file_info['name'] # ëª¨ë¸ íŒŒì¼ í™•ì¥ì í™•ì¸ if name.endswith(('.pt', '.onnx', '.pth')): model_files.append({ 'name': name, 'size': file_info.get('size', 0), 'updated_at': file_info.get('updated_at', ''), 'path': name }) print(f"ğŸ“ Storageì—ì„œ ë°œê²¬ëœ ëª¨ë¸ íŒŒì¼: {len(model_files)}ê°œ") for model in model_files: print(f" - {model['name']} ({model['size']} bytes)") return model_files except Exception as e: print(f" Storage íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}") return [] def register_model_to_database(supabase: Client, model_info): """ëª¨ë¸ì„ model_registryì— ë“±ë¡""" try: # íŒŒì¼ëª…ì—ì„œ ëª¨ë¸ ì •ë³´ ì¶”ì¶œ filename = model_info['name'] # ëª¨ë¸ëª…ê³¼ ë²„ì „ ì¶”ì¶œ (ì˜ˆ: set_76917-1_best.pt -> set_76917-1_best, v1.0.0) model_name = filename.replace('.pt', '').replace('.onnx', '').replace('.pth', '') model_version = f"v1.0.0_{datetime.now().strftime('%Y%m%d_%H%M%S')}" # ëª¨ë¸ íƒ€ì… ê²°ì • if filename.endswith('.onnx'): model_type = 'yolo_onnx' elif filename.endswith('.pt'): model_type = 'yolo_pytorch' else: model_type = 'yolo_pytorch' # ê³µê°œ URL ìƒì„± public_url = supabase.storage.from_('models').get_public_url(model_info['path']) # model_registryì— ë“±ë¡í•  ë°ì´í„° model_data = { 'model_name': model_name, 'model_version': model_version, 'model_type': model_type, 'model_path': public_url, 'pt_model_path': public_url if filename.endswith('.pt') else None, 'is_active': False, # ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” 'performance_metrics': { 'mAP50': 0.0, 'mAP50_95': 0.0, 'precision': 0.0, 'recall': 0.0, 'f1_score': 0.0 }, 'training_metadata': { 'source': 'storage_discovery', 'discovered_at': datetime.now().isoformat(), 'file_size': model_info['size'], 'original_filename': filename }, 'created_at': datetime.now().isoformat(), 'updated_at': datetime.now().isoformat() } # ë°ì´í„°ë² ì´ìŠ¤ì— ì‚½ì… result = supabase.table('model_registry').insert(model_data).execute() if result.data: print(f" ëª¨ë¸ ë“±ë¡ ì™„ë£Œ: {model_name} ({model_version})") return True else: print(f" ëª¨ë¸ ë“±ë¡ ì‹¤íŒ¨: {model_name}") return False except Exception as e: print(f" ëª¨ë¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: {e}") return False def main(): """ë©”ì¸ í•¨ìˆ˜""" print(" Supabase Storage ëª¨ë¸ íŒŒì¼ ë“±ë¡ ì‹œì‘") print("=" * 50) # Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± supabase = get_supabase_client() if not supabase: return # Storageì—ì„œ ëª¨ë¸ íŒŒì¼ ëª©ë¡ ì¡°íšŒ model_files = list_storage_models(supabase) if not model_files: print("ğŸ“­ Storageì— ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.") return # ê° ëª¨ë¸ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡ registered_count = 0 for model_info in model_files: if register_model_to_database(supabase, model_info): registered_count += 1 print(f"\n ë“±ë¡ ì™„ë£Œ: {registered_count}/{len(model_files)}ê°œ ëª¨ë¸") # ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡ í™•ì¸ try: result = supabase.table('model_registry').select('model_name, model_version, is_active').execute() if result.data: print(f"\n í˜„ì¬ ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡:") for model in result.data: status = " í™œì„±" if model['is_active'] else " ë¹„í™œì„±" print(f" - {model['model_name']} ({model['model_version']}) - {status}") except Exception as e: print(f" ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}") if __name__ == "__main__": main() 