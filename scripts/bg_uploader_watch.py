#!/usr/bin/env python3 """ BrickBox 백그라운드 업로더 (폴더 감시 + 업로드 큐 + 재시도) """ import os import time import threading import queue from pathlib import Path from typing import Dict from supabase import create_client SUPABASE_URL = os.getenv('VITE_SUPABASE_URL', '') SERVICE_KEY = os.getenv('SUPABASE_SERVICE_ROLE', '') BUCKET = 'lego-synthetic' class BgUploader: def __init__(self, base_dir: str, concurrency: int = 8): self.base = Path(base_dir) self.q: "queue.Queue[Dict]" = queue.Queue() self.supabase = create_client(SUPABASE_URL, SERVICE_KEY) self.stop = False self.concurrency = concurrency def watcher(self): seen = set() while not self.stop: for part_dir in self.base.iterdir(): if not part_dir.is_dir(): continue part_id = part_dir.name for p in part_dir.iterdir(): if not p.is_file(): continue key = str(p) if key in seen: continue seen.add(key) self.q.put({ 'part_id': part_id, 'path': str(p) }) time.sleep(1) def worker(self): while not self.stop: try: item = self.q.get(timeout=1) except queue.Empty: continue self.upload_one(item) self.q.task_done() def upload_one(self, item: Dict): path = Path(item['path']) filename = path.name part_id = item['part_id'] remote_path = f"synthetic/{part_id}/{filename}" content_type = self._content_type(filename) max_retry = 3 delay = 0.2 for attempt in range(max_retry): try: with open(path, 'rb') as f: data = f.read() res = self.supabase.storage.from_(BUCKET).upload(remote_path, data, file_options={ 'content-type': content_type, 'upsert': True }) if hasattr(res, 'error') and res.error: raise Exception(res.error) return except Exception as e: if attempt < max_retry - 1: time.sleep(delay) delay *= 2 else: try: self.supabase.from('synthetic_upload_failures').upsert({ 'part_id': part_id, 'filename': filename, 'file_path': remote_path, 'error_message': str(e), 'retry_count': attempt + 1, 'last_attempt_at': time.strftime('%Y-%m-%dT%H:%M:%S') }, { 'onConflict': 'file_path' }) except Exception: pass @staticmethod def _content_type(name: str) -> str: n = name.lower() if n.endswith('.webp'): return 'image/webp' if n.endswith('.png'): return 'image/png' if n.endswith('.jpg') or n.endswith('.jpeg'): return 'image/jpeg' if n.endswith('.txt'): return 'text/plain' if n.endswith('.json'): return 'application/json' return 'application/octet-stream' def main(): base = os.getenv('BRICKBOX_WATCH_DIR', r'C:\\cursor\\brickbox\\output\\synthetic') uploader = BgUploader(base) threading.Thread(target=uploader.watcher, daemon=True).start() workers = [threading.Thread(target=uploader.worker, daemon=True) for _ in range(uploader.concurrency)] for t in workers: t.start() print(' BgUploader started. Press Ctrl+C to stop.') try: while True: time.sleep(1) except KeyboardInterrupt: uploader.stop = True if __name__ == '__main__': main() 