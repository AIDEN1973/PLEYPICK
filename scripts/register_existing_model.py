#!/usr/bin/env python3 """ ê¸°ì¡´ Storage ëª¨ë¸ì„ model_registryì— ë“±ë¡ """ import os from datetime import datetime from supabase import create_client, Client def load_env(): """í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ""" env_vars = {} try: with open('.env', 'r', encoding='utf-8') as f: for line in f: line = line.strip() if line and not line.startswith('#') and '=' in line: key, value = line.split('=', 1) env_vars[key] = value except FileNotFoundError: print(" .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.") return None return env_vars def register_existing_model(supabase: Client): """ê¸°ì¡´ ëª¨ë¸ì„ model_registryì— ë“±ë¡""" try: # Storageì—ì„œ íŒŒì¼ ì •ë³´ í™•ì¸ files = supabase.storage.from_('models').list() for file_info in files: filename = file_info.get('name', '') if filename and filename != 'brickbox_s_seg_20251010_034224': continue print(f"ğŸ“ ë°œê²¬ëœ ëª¨ë¸ íŒŒì¼: {filename}") # íŒŒì¼ëª…ì—ì„œ ëª¨ë¸ ì •ë³´ ì¶”ì¶œ model_name = filename model_version = f"v1.0.0_{datetime.now().strftime('%Y%m%d_%H%M%S')}" # ëª¨ë¸ íƒ€ì… ê²°ì • (íŒŒì¼ í™•ì¥ì ê¸°ë°˜) if filename.endswith('.onnx'): model_type = 'yolo_onnx' elif filename.endswith('.pt'): model_type = 'yolo_pytorch' else: model_type = 'yolo_segmentation' # ê¸°ë³¸ê°’ # ê³µê°œ URL ìƒì„± public_url = supabase.storage.from_('models').get_public_url(filename) print(f"ğŸ”— ê³µê°œ URL: {public_url}") # model_registryì— ë“±ë¡í•  ë°ì´í„° model_data = { 'model_name': model_name, 'model_version': model_version, 'version': model_version, # version ì»¬ëŸ¼ë„ ì¶”ê°€ 'model_type': model_type, 'model_path': public_url, 'model_url': public_url, # model_url ì»¬ëŸ¼ë„ ì¶”ê°€ 'pt_model_path': public_url, 'is_active': True, # ì²« ë²ˆì§¸ ëª¨ë¸ì´ë¯€ë¡œ í™œì„±í™” 'performance_metrics': { 'mAP50': 0.0, 'mAP50_95': 0.0, 'precision': 0.0, 'recall': 0.0, 'f1_score': 0.0 }, 'training_metadata': { 'source': 'storage_discovery', 'discovered_at': datetime.now().isoformat(), 'file_size': file_info.get('size', 0), 'original_filename': filename, 'discovered_from': 'models_bucket' }, 'created_at': datetime.now().isoformat(), 'updated_at': datetime.now().isoformat() } # ë°ì´í„°ë² ì´ìŠ¤ì— ì‚½ì… result = supabase.table('model_registry').insert(model_data).execute() if result.data: print(f" ëª¨ë¸ ë“±ë¡ ì™„ë£Œ!") print(f" - ëª¨ë¸ëª…: {model_name}") print(f" - ë²„ì „: {model_version}") print(f" - íƒ€ì…: {model_type}") print(f" - í™œì„±í™”: {'ì˜ˆ' if model_data['is_active'] else 'ì•„ë‹ˆì˜¤'}") return True else: print(f" ëª¨ë¸ ë“±ë¡ ì‹¤íŒ¨") return False except Exception as e: print(f" ëª¨ë¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: {e}") return False def main(): """ë©”ì¸ í•¨ìˆ˜""" print(" ê¸°ì¡´ Storage ëª¨ë¸ ë“±ë¡") print("=" * 50) # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ env_vars = load_env() if not env_vars: return SUPABASE_URL = env_vars.get('VITE_SUPABASE_URL') SUPABASE_KEY = env_vars.get('VITE_SUPABASE_SERVICE_ROLE_KEY') or env_vars.get('VITE_SUPABASE_ANON_KEY') if not SUPABASE_URL or not SUPABASE_KEY: print(" Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.") return # Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± supabase = create_client(SUPABASE_URL, SUPABASE_KEY) # ê¸°ì¡´ ëª¨ë¸ ë“±ë¡ success = register_existing_model(supabase) if success: print(f"\n ë“±ë¡ ì™„ë£Œ!") # ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡ í™•ì¸ try: result = supabase.table('model_registry').select('model_name, model_version, is_active').execute() if result.data: print(f"\n í˜„ì¬ ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡:") for model in result.data: status = " í™œì„±" if model['is_active'] else " ë¹„í™œì„±" print(f" - {model['model_name']} ({model['model_version']}) - {status}") except Exception as e: print(f" ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}") else: print(f"\n ëª¨ë¸ ë“±ë¡ ì‹¤íŒ¨") if __name__ == "__main__": main() 