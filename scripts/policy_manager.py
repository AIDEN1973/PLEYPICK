#!/usr/bin/env python3 """ BrickBox Policy Manager RLS ì •ì±… ë‹¤ì¤‘ ë ˆë²¨í™” ë° ë²„ì „ ê´€ë¦¬ """ import os import sys import json import time import logging from datetime import datetime, timedelta from typing import Dict, List, Optional, Tuple from dataclasses import dataclass from enum import Enum # Supabase í´ë¼ì´ì–¸íŠ¸ import try: from supabase import create_client, Client SUPABASE_URL = os.environ.get("SUPABASE_URL") SUPABASE_KEY = os.environ.get("SUPABASE_KEY") if SUPABASE_URL and SUPABASE_KEY: supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY) else: supabase = None print(" Supabase í™˜ê²½ ë³€ìˆ˜ ì—†ìŒ - DB ë¡œê¹… ë¹„í™œì„±í™”") except ImportError: supabase = None print(" Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ - DB ë¡œê¹… ë¹„í™œì„±í™”") logger = logging.getLogger(__name__) class PolicyType(Enum): """ì •ì±… ìœ í˜•""" PART_ACCESS = "part_access" DATA_ACCESS = "data_access" SYSTEM_ACCESS = "system_access" class SecurityLevel(Enum): """ë³´ì•ˆ ë ˆë²¨""" PUBLIC = "public" INTERNAL = "internal" CONFIDENTIAL = "confidential" RESTRICTED = "restricted" class ChangeType(Enum): """ë³€ê²½ ìœ í˜•""" CREATE = "CREATE" UPDATE = "UPDATE" DELETE = "DELETE" ACTIVATE = "ACTIVATE" DEACTIVATE = "DEACTIVATE" @dataclass class PolicyDefinition: """ì •ì±… ì •ì˜""" policy_id: str policy_type: PolicyType policy_name: str policy_definition: Dict policy_rules: Dict security_level: SecurityLevel access_restrictions: Dict = None user_roles: Dict = None resource_scopes: Dict = None policy_conditions: Dict = None @dataclass class PolicyRevision: """ì •ì±… ë¦¬ë¹„ì „""" revision_id: int policy_id: str revision_number: int policy_version: str policy_definition: Dict policy_rules: Dict security_level: SecurityLevel is_active: bool changed_by: str change_reason: str = None change_type: ChangeType = ChangeType.CREATE effective_from: datetime = None effective_until: datetime = None created_at: datetime = None class PolicyManager: """RLS ì •ì±… ë‹¤ì¤‘ ë ˆë²¨í™” ê´€ë¦¬ì""" def __init__(self, supabase_client=None): self.supabase = supabase_client or supabase def create_policy(self, policy_def: PolicyDefinition, changed_by: str, change_reason: str = None) -> Optional[PolicyRevision]: """ìƒˆ ì •ì±… ìƒì„±""" try: logger.info(f" ì •ì±… ìƒì„± ì‹œì‘: {policy_def.policy_id}") if not self.supabase: logger.warning(" Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ - ì •ì±… ìƒì„± ê±´ë„ˆë›°ê¸°") return None # ì •ì±… ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ result = self.supabase.rpc('create_policy_revision', { 'p_policy_id': policy_def.policy_id, 'p_policy_type': policy_def.policy_type.value, 'p_policy_name': policy_def.policy_name, 'p_policy_definition': policy_def.policy_definition, 'p_policy_rules': policy_def.policy_rules, 'p_security_level': policy_def.security_level.value, 'p_changed_by': changed_by, 'p_change_reason': change_reason, 'p_policy_conditions': policy_def.policy_conditions, 'p_access_restrictions': policy_def.access_restrictions, 'p_user_roles': policy_def.user_roles, 'p_resource_scopes': policy_def.resource_scopes }).execute() if result.data: revision_id = result.data logger.info(f" ì •ì±… ìƒì„± ì™„ë£Œ: {policy_def.policy_id} (ë¦¬ë¹„ì „: {revision_id})") # ìƒì„±ëœ ì •ì±… ì •ë³´ ì¡°íšŒ return self.get_policy_revision(policy_def.policy_id, revision_id) else: logger.error(f" ì •ì±… ìƒì„± ì‹¤íŒ¨: {result}") return None except Exception as e: logger.error(f" ì •ì±… ìƒì„± ì‹¤íŒ¨: {e}") return None def update_policy(self, policy_id: str, policy_definition: Dict, policy_rules: Dict, changed_by: str, change_reason: str = None, policy_conditions: Dict = None, access_restrictions: Dict = None, user_roles: Dict = None, resource_scopes: Dict = None) -> Optional[PolicyRevision]: """ì •ì±… ì—…ë°ì´íŠ¸""" try: logger.info(f" ì •ì±… ì—…ë°ì´íŠ¸ ì‹œì‘: {policy_id}") if not self.supabase: logger.warning(" Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ - ì •ì±… ì—…ë°ì´íŠ¸ ê±´ë„ˆë›°ê¸°") return None # ì •ì±… ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ result = self.supabase.rpc('update_policy_revision', { 'p_policy_id': policy_id, 'p_policy_definition': policy_definition, 'p_policy_rules': policy_rules, 'p_changed_by': changed_by, 'p_change_reason': change_reason, 'p_policy_conditions': policy_conditions, 'p_access_restrictions': access_restrictions, 'p_user_roles': user_roles, 'p_resource_scopes': resource_scopes }).execute() if result.data: revision_id = result.data logger.info(f" ì •ì±… ì—…ë°ì´íŠ¸ ì™„ë£Œ: {policy_id} (ë¦¬ë¹„ì „: {revision_id})") # ì—…ë°ì´íŠ¸ëœ ì •ì±… ì •ë³´ ì¡°íšŒ return self.get_policy_revision(policy_id, revision_id) else: logger.error(f" ì •ì±… ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {result}") return None except Exception as e: logger.error(f" ì •ì±… ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}") return None def delete_policy(self, policy_id: str, changed_by: str, change_reason: str = None) -> bool: """ì •ì±… ì‚­ì œ""" try: logger.info(f"ğŸ—‘ï¸ ì •ì±… ì‚­ì œ ì‹œì‘: {policy_id}") if not self.supabase: logger.warning(" Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ - ì •ì±… ì‚­ì œ ê±´ë„ˆë›°ê¸°") return False # ì •ì±… ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ result = self.supabase.rpc('delete_policy_revision', { 'p_policy_id': policy_id, 'p_changed_by': changed_by, 'p_change_reason': change_reason }).execute() if result.data: logger.info(f" ì •ì±… ì‚­ì œ ì™„ë£Œ: {policy_id}") return True else: logger.error(f" ì •ì±… ì‚­ì œ ì‹¤íŒ¨: {result}") return False except Exception as e: logger.error(f" ì •ì±… ì‚­ì œ ì‹¤íŒ¨: {e}") return False def get_policy_revision(self, policy_id: str, revision_id: int = None) -> Optional[PolicyRevision]: """ì •ì±… ë¦¬ë¹„ì „ ì¡°íšŒ""" try: if not self.supabase: return None query = self.supabase.table('policy_revision_logs').select('*') query = query.eq('policy_id', policy_id) if revision_id: query = query.eq('id', revision_id) else: # ìµœì‹  í™œì„± ë¦¬ë¹„ì „ ì¡°íšŒ query = query.eq('is_active', True).order('revision_number', desc=True).limit(1) result = query.execute() if result.data and len(result.data) > 0: data = result.data[0] return PolicyRevision( revision_id=data['id'], policy_id=data['policy_id'], revision_number=data['revision_number'], policy_version=data['policy_version'], policy_definition=data['policy_definition'], policy_rules=data['policy_rules'], security_level=SecurityLevel(data['security_level']), is_active=data['is_active'], changed_by=data['changed_by'], change_reason=data.get('change_reason'), change_type=ChangeType(data['change_type']), effective_from=datetime.fromisoformat(data['effective_from'].replace('Z', '+00:00')) if data.get('effective_from') else None, effective_until=datetime.fromisoformat(data['effective_until'].replace('Z', '+00:00')) if data.get('effective_until') else None, created_at=datetime.fromisoformat(data['created_at'].replace('Z', '+00:00')) if data.get('created_at') else None ) else: logger.warning(f" ì •ì±… ë¦¬ë¹„ì „ ì—†ìŒ: {policy_id}") return None except Exception as e: logger.error(f" ì •ì±… ë¦¬ë¹„ì „ ì¡°íšŒ ì‹¤íŒ¨: {e}") return None def get_policy_history(self, policy_id: str, include_inactive: bool = False) -> List[PolicyRevision]: """ì •ì±… ì´ë ¥ ì¡°íšŒ""" try: if not self.supabase: return [] # ì •ì±… ì´ë ¥ ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ result = self.supabase.rpc('get_policy_history', { 'p_policy_id': policy_id, 'p_include_inactive': include_inactive }).execute() revisions = [] for data in result.data: revision = PolicyRevision( revision_id=data['revision_id'], policy_id=data['policy_id'], revision_number=data['revision_number'], policy_version=data['policy_version'], policy_definition=data['policy_definition'], policy_rules=data['policy_rules'], security_level=SecurityLevel(data['security_level']), is_active=data['is_active'], changed_by=data['changed_by'], change_reason=data.get('change_reason'), change_type=ChangeType(data['change_type']), effective_from=datetime.fromisoformat(data['effective_from'].replace('Z', '+00:00')) if data.get('effective_from') else None, effective_until=datetime.fromisoformat(data['effective_until'].replace('Z', '+00:00')) if data.get('effective_until') else None, created_at=datetime.fromisoformat(data['created_at'].replace('Z', '+00:00')) if data.get('created_at') else None ) revisions.append(revision) logger.info(f" ì •ì±… ì´ë ¥ ì¡°íšŒ ì™„ë£Œ: {policy_id} - {len(revisions)}ê±´") return revisions except Exception as e: logger.error(f" ì •ì±… ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: {e}") return [] def get_policy_statistics(self) -> Dict: """ì •ì±… í†µê³„ ì¡°íšŒ""" try: if not self.supabase: return {} result = self.supabase.table('policy_revision_stats').select('*').execute() if result.data: stats = {} for data in result.data: policy_type = data['policy_type'] stats[policy_type] = { 'total_revisions': data['total_revisions'], 'active_policies': data['active_policies'], 'inactive_policies': data['inactive_policies'], 'unique_policies': data['unique_policies'], 'avg_revisions_per_policy': float(data['avg_revisions_per_policy']), 'max_revisions': data['max_revisions'], 'created_count': data['created_count'], 'updated_count': data['updated_count'], 'deleted_count': data['deleted_count'], 'activated_count': data['activated_count'], 'deactivated_count': data['deactivated_count'] } logger.info(f" ì •ì±… í†µê³„ ì¡°íšŒ ì™„ë£Œ: {len(stats)}ê°œ ìœ í˜•") return stats else: return {} except Exception as e: logger.error(f" ì •ì±… í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {e}") return {} def get_policy_change_trends(self, days: int = 30) -> List[Dict]: """ì •ì±… ë³€ê²½ ì¶”ì„¸ ì¡°íšŒ""" try: if not self.supabase: return [] from_date = datetime.now() - timedelta(days=days) result = self.supabase.table('policy_change_trends').select('*')\ .gte('date', from_date.isoformat())\ .order('date', desc=True)\ .execute() trends = [] for data in result.data: trends.append({ 'date': data['date'], 'policy_type': data['policy_type'], 'changes_count': data['changes_count'], 'created_count': data['created_count'], 'updated_count': data['updated_count'], 'deleted_count': data['deleted_count'], 'affected_policies': data['affected_policies'], 'unique_changers': data['unique_changers'] }) logger.info(f" ì •ì±… ë³€ê²½ ì¶”ì„¸ ì¡°íšŒ ì™„ë£Œ: {len(trends)}ê±´") return trends except Exception as e: logger.error(f" ì •ì±… ë³€ê²½ ì¶”ì„¸ ì¡°íšŒ ì‹¤íŒ¨: {e}") return [] def main(): """ì •ì±… ê´€ë¦¬ ë©”ì¸ í•¨ìˆ˜""" try: print("ğŸ”’ BrickBox ì •ì±… ê´€ë¦¬ ì‹œì‘") # ì •ì±… ê´€ë¦¬ì ì´ˆê¸°í™” manager = PolicyManager() # ì˜ˆì‹œ ì •ì±… ìƒì„± policy_def = PolicyDefinition( policy_id="part_access_001", policy_type=PolicyType.PART_ACCESS, policy_name="ë¶€í’ˆ ì ‘ê·¼ ì •ì±…", policy_definition={ "description": "ë¶€í’ˆë³„ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬", "scope": "parts_master_features" }, policy_rules={ "read": ["admin", "editor", "viewer"], "write": ["admin", "editor"], "delete": ["admin"] }, security_level=SecurityLevel.INTERNAL, access_restrictions={ "restricted_parts": ["confidential", "restricted"], "allowed_operations": ["read", "write"] }, user_roles={ "admin": ["*"], "editor": ["read", "write"], "viewer": ["read"] }, resource_scopes={ "tables": ["parts_master_features", "part_images"], "columns": ["*"] } ) # ì •ì±… ìƒì„± revision = manager.create_policy( policy_def, changed_by="admin_user", change_reason="ì´ˆê¸° ì •ì±… ìƒì„±" ) if revision: print(f" ì •ì±… ìƒì„± ì™„ë£Œ:") print(f"ì •ì±… ID: {revision.policy_id}") print(f"ë¦¬ë¹„ì „: {revision.revision_number}") print(f"ë²„ì „: {revision.policy_version}") print(f"ë³´ì•ˆ ë ˆë²¨: {revision.security_level.value}") print(f"í™œì„± ìƒíƒœ: {revision.is_active}") # ì •ì±… ì´ë ¥ ì¡°íšŒ history = manager.get_policy_history(revision.policy_id, include_inactive=True) print(f"\n ì •ì±… ì´ë ¥: {len(history)}ê±´") # ì •ì±… í†µê³„ ì¡°íšŒ stats = manager.get_policy_statistics() print(f"\n ì •ì±… í†µê³„: {len(stats)}ê°œ ìœ í˜•") for policy_type, stat in stats.items(): print(f" {policy_type}: {stat['active_policies']}ê°œ í™œì„±, {stat['total_revisions']}ê°œ ë¦¬ë¹„ì „") return True else: print(" ì •ì±… ìƒì„± ì‹¤íŒ¨") return False except Exception as e: logger.error(f" ì •ì±… ê´€ë¦¬ ì‹¤íŒ¨: {e}") return False if __name__ == "__main__": success = main() sys.exit(0 if success else 1) 