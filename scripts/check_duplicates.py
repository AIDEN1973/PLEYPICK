#!/usr/bin/env python3 """ Supabase ì¤‘ë³µ íŒŒì¼ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œì»¬ í´ë”ì™€ Supabase Storageì˜ ì¤‘ë³µ íŒŒì¼ í™•ì¸ """ import os import sys import json import logging from pathlib import Path from datetime import datetime from supabase import create_client, Client # ë¡œê¹… ì„¤ì • logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') logger = logging.getLogger(__name__) class DuplicateChecker: """ì¤‘ë³µ íŒŒì¼ í™•ì¸ í´ë˜ìŠ¤""" def __init__(self, supabase_url: str, supabase_key: str): self.supabase_url = supabase_url self.supabase_key = supabase_key self.supabase: Client = create_client(supabase_url, supabase_key) def get_local_files(self, local_folder: str) -> dict: """ë¡œì»¬ í´ë”ì˜ íŒŒì¼ ì •ë³´ ìˆ˜ì§‘""" local_path = Path(local_folder) if not local_path.exists(): logger.error(f" ë¡œì»¬ í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {local_folder}") return {} files_info = {} for file_path in local_path.rglob('*'): if file_path.is_file(): file_info = { 'name': file_path.name, 'path': str(file_path), 'size': file_path.stat().st_size, 'modified': datetime.fromtimestamp(file_path.stat().st_mtime), 'relative_path': str(file_path.relative_to(local_path)) } files_info[file_path.name] = file_info logger.info(f"[DIR] ë¡œì»¬ íŒŒì¼: {len(files_info)}ê°œ") return files_info def get_remote_files(self, remote_folder: str = 'synthetic') -> dict: """Supabase Storageì˜ íŒŒì¼ ì •ë³´ ìˆ˜ì§‘""" try: result = self.supabase.storage.from_('lego-synthetic').list(remote_folder) if hasattr(result, 'error') and result.error: logger.error(f" ì›ê²© íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {result.error}") return {} files_info = {} for file_info in result: if file_info.get('name'): files_info[file_info['name']] = { 'name': file_info['name'], 'size': file_info.get('size', 0), 'modified': file_info.get('updated_at', ''), 'path': f"{remote_folder}/{file_info['name']}" } logger.info(f"â˜ï¸ ì›ê²© íŒŒì¼: {len(files_info)}ê°œ") return files_info except Exception as e: logger.error(f" ì›ê²© íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨: {e}") return {} def check_duplicates(self, local_folder: str, remote_folder: str = 'synthetic') -> dict: """ì¤‘ë³µ íŒŒì¼ í™•ì¸""" logger.info(" ì¤‘ë³µ íŒŒì¼ í™•ì¸ ì‹œì‘...") # ë¡œì»¬ íŒŒì¼ ì •ë³´ ìˆ˜ì§‘ local_files = self.get_local_files(local_folder) if not local_files: return {'duplicates': [], 'local_only': [], 'remote_only': []} # ì›ê²© íŒŒì¼ ì •ë³´ ìˆ˜ì§‘ remote_files = self.get_remote_files(remote_folder) # ì¤‘ë³µ íŒŒì¼ í™•ì¸ duplicates = [] local_only = [] remote_only = [] # ë¡œì»¬ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸ for filename, local_info in local_files.items(): if filename in remote_files: remote_info = remote_files[filename] duplicates.append({ 'filename': filename, 'local': local_info, 'remote': remote_info, 'size_match': local_info['size'] == remote_info['size'] }) else: local_only.append(local_info) # ì›ê²©ì—ë§Œ ìˆëŠ” íŒŒì¼ í™•ì¸ for filename, remote_info in remote_files.items(): if filename not in local_files: remote_only.append(remote_info) result = { 'duplicates': duplicates, 'local_only': local_only, 'remote_only': remote_only, 'summary': { 'total_local': len(local_files), 'total_remote': len(remote_files), 'duplicates_count': len(duplicates), 'local_only_count': len(local_only), 'remote_only_count': len(remote_only) } } return result def print_report(self, result: dict): """ì¤‘ë³µ í™•ì¸ ê²°ê³¼ ë¦¬í¬íŠ¸ ì¶œë ¥""" summary = result['summary'] print("\n" + "="*60) print(" ì¤‘ë³µ íŒŒì¼ í™•ì¸ ê²°ê³¼") print("="*60) print(f"[DIR] ë¡œì»¬ íŒŒì¼: {summary['total_local']}ê°œ") print(f"â˜ï¸ ì›ê²© íŒŒì¼: {summary['total_remote']}ê°œ") print(f" ì¤‘ë³µ íŒŒì¼: {summary['duplicates_count']}ê°œ") print(f" ë¡œì»¬ë§Œ ìˆìŒ: {summary['local_only_count']}ê°œ") print(f"â˜ï¸ ì›ê²©ë§Œ ìˆìŒ: {summary['remote_only_count']}ê°œ") # ì¤‘ë³µ íŒŒì¼ ìƒì„¸ ì •ë³´ if result['duplicates']: print(f"\n ì¤‘ë³µ íŒŒì¼ ëª©ë¡ ({len(result['duplicates'])}ê°œ):") for dup in result['duplicates']: size_match = "" if dup['size_match'] else "" print(f" {size_match} {dup['filename']} (í¬ê¸° ì¼ì¹˜: {dup['size_match']})") # ë¡œì»¬ì—ë§Œ ìˆëŠ” íŒŒì¼ if result['local_only']: print(f"\n ë¡œì»¬ì—ë§Œ ìˆëŠ” íŒŒì¼ ({len(result['local_only'])}ê°œ):") for file_info in result['local_only'][:10]: # ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ print(f" ğŸ“„ {file_info['name']} ({file_info['size']} bytes)") if len(result['local_only']) > 10: print(f" ... ë° {len(result['local_only']) - 10}ê°œ ë”") # ì›ê²©ì—ë§Œ ìˆëŠ” íŒŒì¼ if result['remote_only']: print(f"\nâ˜ï¸ ì›ê²©ì—ë§Œ ìˆëŠ” íŒŒì¼ ({len(result['remote_only'])}ê°œ):") for file_info in result['remote_only'][:10]: # ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ print(f" ğŸ“„ {file_info['name']} ({file_info['size']} bytes)") if len(result['remote_only']) > 10: print(f" ... ë° {len(result['remote_only']) - 10}ê°œ ë”") print("="*60) def save_report(self, result: dict, output_file: str = None): """ì¤‘ë³µ í™•ì¸ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥""" if not output_file: timestamp = datetime.now().strftime('%Y%m%d_%H%M%S') output_file = f"duplicate_check_report_{timestamp}.json" try: with open(output_file, 'w', encoding='utf-8') as f: json.dump(result, f, indent=2, ensure_ascii=False, default=str) logger.info(f"ğŸ“„ ë¦¬í¬íŠ¸ ì €ì¥: {output_file}") return output_file except Exception as e: logger.error(f" ë¦¬í¬íŠ¸ ì €ì¥ ì‹¤íŒ¨: {e}") return None def main(): """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜""" if len(sys.argv) < 2: print("ì‚¬ìš©ë²•: python check_duplicates.py <local_folder> [remote_folder] [--save-report]") print("ì˜µì…˜:") print(" --save-report: ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥") print("\nì‚¬ìš©ë²•:") print(" python check_duplicates.py output/renders/3001") print(" python check_duplicates.py output/renders/3001 synthetic --save-report") sys.exit(1) local_folder = sys.argv[1] remote_folder = sys.argv[2] if len(sys.argv) > 2 and not sys.argv[2].startswith('--') else 'synthetic' save_report = '--save-report' in sys.argv # Supabase ì„¤ì • supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') supabase_key = os.getenv('VITE_SUPABASE_ANON_KEY', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wZmVyYnh1eG9jYmZuZmJwY256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzQ5ODUsImV4cCI6MjA3NTA1MDk4NX0.eqKQh_o1k2VmP-_v__gUMHVOgvdIzml-zDhZyzfxUmk') try: # ì¤‘ë³µ í™•ì¸ ì‹¤í–‰ checker = DuplicateChecker(supabase_url, supabase_key) result = checker.check_duplicates(local_folder, remote_folder) # ê²°ê³¼ ì¶œë ¥ checker.print_report(result) # ë¦¬í¬íŠ¸ ì €ì¥ (ì„ íƒì‚¬í•­) if save_report: report_file = checker.save_report(result) if report_file: print(f"\nğŸ“„ ìƒì„¸ ë¦¬í¬íŠ¸ ì €ì¥: {report_file}") # ì¤‘ë³µ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° ê²½ê³  if result['duplicates']: print(f"\n ê²½ê³ : {len(result['duplicates'])}ê°œì˜ ì¤‘ë³µ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤!") print(" ê¶Œì¥ì‚¬í•­:") print(" 1. ë°±ì—… ìƒì„± í›„ ì—…ë¡œë“œ") print(" 2. íŒŒì¼ëª…ì— íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€") print(" 3. ë‹¤ë¥¸ í´ë”ëª…ìœ¼ë¡œ ì—…ë¡œë“œ") else: print(f"\n ì¤‘ë³µ íŒŒì¼ ì—†ìŒ - ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤!") except Exception as e: logger.error(f" ì‹¤í–‰ ì‹¤íŒ¨: {e}") sys.exit(1) if __name__ == "__main__": main() 