#!/usr/bin/env python3 """ ğŸ›¡ï¸ Supabase ì•ˆì „ ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë³µ í™•ì¸, ë°±ì—… ìƒì„±, ì•ˆì „í•œ ì—…ë¡œë“œ """ import os import sys import json import shutil import logging from pathlib import Path from datetime import datetime from typing import Dict, List, Optional from supabase import create_client, Client # ë¡œê¹… ì„¤ì • logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') logger = logging.getLogger(__name__) class SafeUploader: """ì•ˆì „í•œ ì—…ë¡œë“œ ê´€ë¦¬ì""" def __init__(self, supabase_url: str, supabase_key: str): self.supabase_url = supabase_url self.supabase_key = supabase_key self.supabase: Client = create_client(supabase_url, supabase_key) def check_duplicates(self, local_folder: str, remote_folder: str = 'synthetic') -> Dict: """ì¤‘ë³µ íŒŒì¼ í™•ì¸""" from check_duplicates import DuplicateChecker checker = DuplicateChecker(self.supabase_url, self.supabase_key) return checker.check_duplicates(local_folder, remote_folder) def create_backup(self, remote_folder: str, backup_name: str = None) -> bool: """ì›ê²© íŒŒì¼ ë°±ì—… ìƒì„±""" try: if not backup_name: backup_name = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}" logger.info(f" ì›ê²© íŒŒì¼ ë°±ì—… ìƒì„±: {backup_name}") # ì›ê²© íŒŒì¼ ëª©ë¡ ì¡°íšŒ result = self.supabase.storage.from_('lego-synthetic').list(remote_folder) if hasattr(result, 'error') and result.error: logger.error(f" ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {result.error}") return False # ë°±ì—… í´ë” ìƒì„± backup_folder = f"{remote_folder}_backup/{backup_name}" # íŒŒì¼ ë³µì‚¬ copied_count = 0 for file_info in result: if file_info.get('name'): source_path = f"{remote_folder}/{file_info['name']}" dest_path = f"{backup_folder}/{file_info['name']}" try: # íŒŒì¼ ë‹¤ìš´ë¡œë“œ file_data = self.supabase.storage.from_('lego-synthetic').download(source_path) # ë°±ì—… ìœ„ì¹˜ì— ì—…ë¡œë“œ self.supabase.storage.from_('lego-synthetic').upload( dest_path, file_data, file_options={"upsert": True} ) copied_count += 1 logger.info(f" ë°±ì—… ì™„ë£Œ: {file_info['name']}") except Exception as e: logger.warning(f" ë°±ì—… ì‹¤íŒ¨ {file_info['name']}: {e}") logger.info(f" ë°±ì—… ì™„ë£Œ: {copied_count}ê°œ íŒŒì¼") return True except Exception as e: logger.error(f" ë°±ì—… ìƒì„± ì‹¤íŒ¨: {e}") return False def safe_upload_folder(self, local_folder: str, remote_folder: str = None, backup_existing: bool = True, check_duplicates: bool = True) -> Dict: """ì•ˆì „í•œ í´ë” ì—…ë¡œë“œ""" local_path = Path(local_folder) if not local_path.exists(): return {'success': False, 'message': 'ë¡œì»¬ í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ'} # ì›ê²© í´ë”ëª… ì„¤ì • if not remote_folder: remote_folder = local_path.name logger.info(f"ğŸ›¡ï¸ ì•ˆì „ ì—…ë¡œë“œ ì‹œì‘: {local_folder} â†’ {remote_folder}") # 1. ì¤‘ë³µ íŒŒì¼ í™•ì¸ if check_duplicates: logger.info(" ì¤‘ë³µ íŒŒì¼ í™•ì¸ ì¤‘...") duplicate_result = self.check_duplicates(local_folder, remote_folder) if duplicate_result['duplicates']: logger.warning(f" ì¤‘ë³µ íŒŒì¼ ë°œê²¬: {len(duplicate_result['duplicates'])}ê°œ") # ì‚¬ìš©ì í™•ì¸ response = input("ì¤‘ë³µ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ") if response.lower() != 'y': return {'success': False, 'message': 'ì‚¬ìš©ìê°€ ì—…ë¡œë“œë¥¼ ì·¨ì†Œí•¨'} # 2. ê¸°ì¡´ íŒŒì¼ ë°±ì—… if backup_existing: if not self.create_backup(remote_folder): logger.warning(" ë°±ì—… ìƒì„± ì‹¤íŒ¨, ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤") # 3. ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œ try: from manual_upload_supabase import ManualUploader uploader = ManualUploader(self.supabase_url, self.supabase_key) upload_result = uploader.upload_folder(local_folder, remote_folder) if upload_result['success']: logger.info(" ì•ˆì „ ì—…ë¡œë“œ ì™„ë£Œ!") # 4. ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” (ì„ íƒì‚¬í•­) sync_response = input("ë°ì´í„°ë² ì´ìŠ¤ì— ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): ") if sync_response.lower() != 'n': part_id = input("Part IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enterë¡œ ìë™ ì„¤ì •): ").strip() if not part_id: part_id = remote_folder if uploader.sync_to_database(remote_folder, part_id): logger.info(" ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” ì™„ë£Œ!") else: logger.warning(" ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” ì‹¤íŒ¨") return { 'success': True, 'message': 'ì•ˆì „ ì—…ë¡œë“œ ì™„ë£Œ', 'upload_result': upload_result } else: return { 'success': False, 'message': f'ì—…ë¡œë“œ ì‹¤íŒ¨: {upload_result["message"]}', 'upload_result': upload_result } except Exception as e: logger.error(f" ì•ˆì „ ì—…ë¡œë“œ ì‹¤íŒ¨: {e}") return {'success': False, 'message': f'ì—…ë¡œë“œ ì‹¤íŒ¨: {e}'} def restore_backup(self, backup_folder: str, target_folder: str) -> bool: """ë°±ì—…ì—ì„œ ë³µì›""" try: logger.info(f" ë°±ì—… ë³µì›: {backup_folder} â†’ {target_folder}") # ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ result = self.supabase.storage.from_('lego-synthetic').list(backup_folder) if hasattr(result, 'error') and result.error: logger.error(f" ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {result.error}") return False # íŒŒì¼ ë³µì› restored_count = 0 for file_info in result: if file_info.get('name'): source_path = f"{backup_folder}/{file_info['name']}" dest_path = f"{target_folder}/{file_info['name']}" try: # ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ file_data = self.supabase.storage.from_('lego-synthetic').download(source_path) # ì›ë˜ ìœ„ì¹˜ì— ë³µì› self.supabase.storage.from_('lego-synthetic').upload( dest_path, file_data, file_options={"upsert": True} ) restored_count += 1 logger.info(f" ë³µì› ì™„ë£Œ: {file_info['name']}") except Exception as e: logger.warning(f" ë³µì› ì‹¤íŒ¨ {file_info['name']}: {e}") logger.info(f" ë³µì› ì™„ë£Œ: {restored_count}ê°œ íŒŒì¼") return True except Exception as e: logger.error(f" ë°±ì—… ë³µì› ì‹¤íŒ¨: {e}") return False def main(): """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜""" if len(sys.argv) < 2: print("ì‚¬ìš©ë²•: python safe_upload_supabase.py <local_folder> [options]") print("ì˜µì…˜:") print(" --no-backup: ë°±ì—… ìƒì„± ì•ˆí•¨") print(" --no-check: ì¤‘ë³µ í™•ì¸ ì•ˆí•¨") print(" --restore <backup_folder>: ë°±ì—…ì—ì„œ ë³µì›") print("\nì‚¬ìš©ë²•:") print(" python safe_upload_supabase.py output/renders/3001") print(" python safe_upload_supabase.py output/renders/3001 --no-backup") print(" python safe_upload_supabase.py --restore synthetic_backup/backup_20250107_143022") sys.exit(1) # ë³µì› ëª¨ë“œ if '--restore' in sys.argv: try: restore_idx = sys.argv.index('--restore') backup_folder = sys.argv[restore_idx + 1] target_folder = sys.argv[restore_idx + 2] if len(sys.argv) > restore_idx + 2 else 'synthetic' # Supabase ì„¤ì • supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') supabase_key = os.getenv('VITE_SUPABASE_ANON_KEY', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wZmVyYnh1eG9jYmZuZmJwY256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzQ5ODUsImV4cCI6MjA3NTA1MDk4NX0.eqKQh_o1k2VmP-_v__gUMHVOgvdIzml-zDhZyzfxUmk') uploader = SafeUploader(supabase_url, supabase_key) if uploader.restore_backup(backup_folder, target_folder): print(" ë°±ì—… ë³µì› ì™„ë£Œ!") else: print(" ë°±ì—… ë³µì› ì‹¤íŒ¨!") sys.exit(1) except (ValueError, IndexError): print(" ì˜ëª»ëœ ë³µì› ëª…ë ¹ì–´") sys.exit(1) return # ì¼ë°˜ ì—…ë¡œë“œ ëª¨ë“œ local_folder = sys.argv[1] remote_folder = sys.argv[2] if len(sys.argv) > 2 and not sys.argv[2].startswith('--') else None backup_existing = '--no-backup' not in sys.argv check_duplicates = '--no-check' not in sys.argv # Supabase ì„¤ì • supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') supabase_key = os.getenv('VITE_SUPABASE_ANON_KEY', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wZmVyYnh1eG9jYmZuZmJwY256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzQ5ODUsImV4cCI6MjA3NTA1MDk4NX0.eqKQh_o1k2VmP-_v__gUMHVOgvdIzml-zDhZyzfxUmk') try: # ì•ˆì „ ì—…ë¡œë“œ ì‹¤í–‰ uploader = SafeUploader(supabase_url, supabase_key) result = uploader.safe_upload_folder( local_folder, remote_folder, backup_existing, check_duplicates ) if result['success']: print(" ì•ˆì „ ì—…ë¡œë“œ ì™„ë£Œ!") else: print(f" ì•ˆì „ ì—…ë¡œë“œ ì‹¤íŒ¨: {result['message']}") sys.exit(1) except Exception as e: logger.error(f" ì‹¤í–‰ ì‹¤íŒ¨: {e}") sys.exit(1) if __name__ == "__main__": main() 