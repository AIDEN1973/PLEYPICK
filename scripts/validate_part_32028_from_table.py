#!/usr/bin/env python3
"""
사용자가 제공한 테이블 데이터에서 part_id 32028 검증
"""

import json
import numpy as np

# 제공된 테이블 데이터에서 추출한 샘플
# clip_text_emb: 첫 몇 개와 마지막 몇 개만 확인
clip_sample_start = [-0.03648197, 0.013121663, 0.03776209, 0.005743566, -0.027302299, 0.032464754]
clip_sample_end = [-0.018985402, -0.023897516, -0.02105349, 0.004741229, 0.0062951837, 0.04389449, -0.0014819369, 0.00070397, 0.027547743, 0.01673727, 0.018660992, -0.02731418, 0.016408335, 0.002085675, 0.009629698, -0.04145019, 0.015752582, -0.012564666, 0.018270291, -0.068937056, -0.044971403, 0.00053253514, -0.009229985, 0.016329287, -0.012314829, -0.024609262, -0.010053108, 0.03356103, 0.0009089677, -0.022584138, 0.03106419, -0.0023090926, 0.016471108, -0.015093978, 0.053757884, 0.04810914, 0.053585205, -0.007547443, 0.055502906, 0.012230293, 0.027039457, 0.021619504, 0.0042742887, 0.02344697, -0.0069686384, -0.006556619, -0.056652352, 0.046533126, 0.04215097, 0.01617037, 0.0004363102, -0.01826581, -0.0111477375, 0.020626767, -0.015823685, 0.004968519, 0.037307415, 0.013516466, -0.006329786, -0.0276185, -0.03448772, -0.009433541, 0.0076709306, 0.018129257, 0.026109582, 0.03326391, -0.076845154, 0.008516099, -0.0011478991, -0.0016603036, -0.015084468, 0.00894466, -0.029516347, -0.059479296, -0.018524125, 0.0013866313, 0.025200207, -0.008913899, 0.06901091, 0.022702217, 0.0047658836, 0.0070723793, -0.015005496, 0.016595121, 0.05443452, -0.017768482, 0.007863554, 0.004748433, 0.013484643, -0.016874917, 0.010140531, -0.036564525, -0.007426749, -0.023769323, -0.01852378, -0.009599149, 0.010080738, 0.019324923, 0.01126248, 0.037476715, 0.03694902, 0.0146993585, -0.015274437, 0.011861969, -0.0005686001, 0.010300459, -0.006093109, -0.043529514, -0.012927961, -0.017649364, 0.036210284]

# semantic_vector 샘플 (테이블에서 추출)
# 앞부분과 후반부를 확인하여 제로 패딩 여부 확인
semantic_start = [0.032047138, -0.091399886, 0.0014704738, -0.039518602, 0.01689085, -0.0010883667]
semantic_mid = [0.010708034, -0.0019471371, 0.0005543487, 0.0002745618, 0.0035903687, 0.006327336, 0.0040658317, 0.0029123437, -0.0012913367, 0.000423468, 0.0034507655, 0.004512139, 0.0020614183, -0.00065394206, -0.0021332393, -0.0041323667, -0.0049158446, -0.0054667476, -0.0029447342, -0.0047826017, -0.0060240943, -0.0036738184, 0.007104835, -0.005074892, -0.0029693597, 0.0056043305, -0.0012074031, 0.007448492, 0.0051250514, 0.0010458542, 9.6008866e-05, 0.0049511762, -0.0070156064, -0.0013221183, 0.0012058334, 0.0027852014, 0.0033443302, -0.0046780156, -0.0028679422, 0.002245019, -0.0023305295, 0.0038652325, -0.0051592416, 0.0032316912, -0.0047398913, -0.0030744078, 0.0011611014, 0.0031250003, -0.008917577, -0.00031419238, 0.01013757, 0.005850994, 0.0024292795, 0.0030528042, 0.008231156, 0.0054915035, 0.002010892, 0.0068399482, -0.002601107, -0.0016121382, -0.0016331769, -0.0028822396, -0.005273688, 0.0038105955, 0.006242309, 0.004515404, 0.0077298153, -0.0016537902, -0.0010606492, 0.005988697, 0.0071965433, -0.005497643, 0.0053075836, 0.0038673098, 0.0007684738, -0.0022375903, 0.0025233289, -0.0018865227, -0.0059557348, -0.0028971864, 0.006626126, -8.218721e-05, 0.007070197, 0.0029982452, 0.0076097287, -0.0051789833, -0.0028163905, -0.0014210393, 0.0026845818, 0.0015960303, -0.0018925067, -0.002532348, -0.004033649, -0.005589731, 0.0014768185, -0.003997916, -0.00037659684, -0.002143701, -0.00088565197, -0.0032454047, 0.00036386726, 0.0002491134, -0.005339416, -0.0008066444, -0.0008020403, 0.0054734657, -0.0036704126, 0.0019414447, -0.0007365705, -0.0032819367, 0.0015300949, -0.0005187725, -0.0030503445, 0.0055326847, 0.002954238, -0.0052312934, 0.0012212152, -0.0013092776, 0.006431849, -0.0036732391, 0.00070401956, -0.0042764083, -0.0033077402, 0.00040696395, -0.0077476786, 0.0032115807, 0.0057600453, 0.00630643, -0.00086880487, 0.010154203, -0.0069270497, -0.0015127767, -0.006593053, 0.00058097637, -0.003065116, -0.0049865292, 0.00019484125, -0.0007189129, -0.0032295492, -0.0058541754, -0.0017436099, 0.0018523925, 0.0086597325, -0.0011900138]
semantic_end = [-0.0011900138]

def analyze_vector_pattern(vector_data, name, position=""):
    """벡터 패턴 분석"""
    try:
        v = np.array(vector_data, dtype=np.float32)
        norm = np.linalg.norm(v)
        abs_mean = np.mean(np.abs(v))
        abs_max = np.max(np.abs(v))
        abs_min = np.min(np.abs(v))
        
        # 매우 작은 값의 비율 (1e-5 이하)
        tiny_count = np.sum(np.abs(v) < 1e-5)
        tiny_ratio = tiny_count / len(v)
        
        return {
            "name": f"{name}{position}",
            "length": len(v),
            "norm": float(norm),
            "abs_mean": float(abs_mean),
            "abs_max": float(abs_max),
            "abs_min": float(abs_min),
            "tiny_count": int(tiny_count),
            "tiny_ratio": float(tiny_ratio),
            "is_near_zero": norm < 0.01 or abs_mean < 1e-4
        }
    except Exception as e:
        return {"error": str(e)}

def main():
    print("=" * 80)
    print("part_id 32028 데이터 검증 (테이블 데이터 기반)")
    print("=" * 80)
    
    # 1. 기본 정보
    print("\n[1/5] 기본 정보")
    print("  part_id: 32028")
    print("  color_id: 1")
    print("  part_name: 32028")
    print("  confidence: 0.95 [OK]")
    print("  usage_frequency: 0")
    
    # 2. feature_json
    print("\n[2/5] feature_json 검증")
    print("  [OK] shape_tag: plate")
    print("  [OK] stud_count_top: 2")
    print("  [OK] tube_count_bottom: 0")
    print("  [OK] confusions: ['3001', '3004']")
    print("  [OK] recognition_hints: 존재")
    print("  [OK] feature_text: LLM 생성 메타데이터 포함")
    
    # 3. clip_text_emb 분석
    print("\n[3/5] clip_text_emb 벡터 분석")
    # 전체 벡터 길이 확인 (테이블에서 보면 768차원으로 보임)
    clip_analysis = analyze_vector_pattern(clip_sample_start + [0] * (768 - len(clip_sample_start)), "clip_text_emb", " (추정)")
    print(f"  [WARNING]  전체 벡터 데이터 없음 (샘플만 확인)")
    print(f"  [REPORT] 예상: 768차원")
    print(f"  [REPORT] 테이블에서 확인: 값 범위 -0.xx ~ 0.xx (정상)")
    print(f"  [INFO] 추정: 정상 CLIP 임베딩 (제로 벡터 아님)")
    
    # 4. semantic_vector 분석
    print("\n[4/5] semantic_vector 벡터 분석")
    print("  [WARNING]  주의: 테이블에서 semantic_vector 후반부 확인 필요")
    
    # 앞부분 분석
    front_analysis = analyze_vector_pattern(semantic_start, "semantic_vector", " (앞부분)")
    print(f"\n  앞부분 (0~50차원 추정):")
    print(f"    norm: {front_analysis.get('norm', 'N/A'):.6f}")
    print(f"    abs_mean: {front_analysis.get('abs_mean', 'N/A'):.6f}")
    print(f"    abs_max: {front_analysis.get('abs_max', 'N/A'):.6f}")
    
    # 중반부 분석
    mid_analysis = analyze_vector_pattern(semantic_mid, "semantic_vector", " (중반부)")
    print(f"\n  중반부 (500~768차원 추정):")
    print(f"    norm: {mid_analysis.get('norm', 'N/A'):.6f}")
    print(f"    abs_mean: {mid_analysis.get('abs_mean', 'N/A'):.6f}")
    print(f"    abs_max: {mid_analysis.get('abs_max', 'N/A'):.6f}")
    print(f"    abs_min: {mid_analysis.get('abs_min', 'N/A'):.6f}")
    print(f"    매우 작은 값 비율 (|v| < 1e-5): {mid_analysis.get('tiny_ratio', 0)*100:.1f}%")
    
    if mid_analysis.get('abs_mean', 0) < 0.001:
        print(f"    [WARNING]  경고: 중반부 평균 절댓값이 매우 작음 (제로 패딩 의심)")
    else:
        print(f"    [OK] 중반부 값 범위 정상")
    
    # 5. 종합 판단
    print("\n[5/5] 종합 판단")
    print("  [OK] feature_json: 정상 (LLM 생성 메타데이터 포함)")
    print("  [OK] recognition_hints: 정상")
    print("  [OK] clip_text_emb: 추정 정상 (제로 벡터 아님)")
    print("  [WARNING]  semantic_vector: 후반부 제로 패딩 가능성 (추가 확인 필요)")
    print("\n  [REPORT] 권장 조치:")
    print("    1. semantic_vector 전체 768차원 데이터 확인")
    print("    2. 후반부 256차원 (512~768) norm 계산")
    print("    3. 제로 패딩 발견 시 fixZeroPaddingVectors() 실행")
    
    print("\n" + "=" * 80)
    print("검증 완료")
    print("=" * 80)

if __name__ == "__main__":
    main()

