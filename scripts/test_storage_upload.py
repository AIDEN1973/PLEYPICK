#!/usr/bin/env python3 """ BrickBox Storage 업로드 테스트 스크립트 RLS 정책 설정 후 업로드 기능 테스트 """ import os import sys import json import time from pathlib import Path from supabase import create_client, Client def test_storage_upload(): """Storage 업로드 테스트""" # Supabase 설정 supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') supabase_key = os.getenv('VITE_SUPABASE_ANON_KEY', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wZmVyYnh1eG9jYmZuZmJwY256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzQ5ODUsImV4cCI6MjA3NTA1MDk4NX0.eqKQh_o1k2VmP-_v__gUMHVOgvdIzml-zDhZyzfxUmk') try: supabase = create_client(supabase_url, supabase_key) print("[PASS] Supabase 클라이언트 생성 성공") # 테스트 파일 생성 test_data = b"Test upload data for lego-synthetic bucket" test_path = "synthetic/test/upload_test.txt" print(f"[INFO] 테스트 업로드 시작: {test_path}") # 업로드 시도 result = supabase.storage.from_('lego-synthetic').upload( test_path, test_data, file_options={"content-type": "text/plain", "upsert": "true"} ) # 결과 확인 if hasattr(result, 'error') and result.error: print(f"[FAIL] 업로드 실패: {result.error}") return False else: print("[PASS] 업로드 성공!") # 공개 URL 생성 테스트 url_data = supabase.storage.from_('lego-synthetic').get_public_url(test_path) public_url = url_data.publicUrl if hasattr(url_data, 'publicUrl') else str(url_data) print(f"[INFO] 공개 URL: {public_url}") return True except Exception as e: print(f"[ERROR] 테스트 실패: {e}") return False def test_with_service_role(): """Service Role Key로 테스트""" service_role_key = os.getenv('SUPABASE_SERVICE_ROLE_KEY') if not service_role_key: print("[WARN] SUPABASE_SERVICE_ROLE_KEY 환경변수가 설정되지 않았습니다") print("[INFO] Supabase 대시보드 → Settings → API → service_role key 복사") return False try: supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') supabase = create_client(supabase_url, service_role_key) print("[PASS] Service Role 클라이언트 생성 성공") # 테스트 파일 생성 test_data = b"Service role test upload" test_path = "synthetic/test/service_role_test.txt" print(f"[INFO] Service Role 업로드 시작: {test_path}") result = supabase.storage.from_('lego-synthetic').upload( test_path, test_data, file_options={"content-type": "text/plain", "upsert": "true"} ) if hasattr(result, 'error') and result.error: print(f"[FAIL] Service Role 업로드 실패: {result.error}") return False else: print("[PASS] Service Role 업로드 성공!") return True except Exception as e: print(f"[ERROR] Service Role 테스트 실패: {e}") return False def main(): """메인 테스트 함수""" print("[TEST] BrickBox Storage 업로드 테스트") print("=" * 50) # 1. Anon Key로 테스트 print("\n[1] Anon Key 테스트") anon_success = test_storage_upload() # 2. Service Role Key로 테스트 print("\n[2] Service Role Key 테스트") service_success = test_with_service_role() # 결과 요약 print("\n[RESULT] 테스트 결과 요약") print("=" * 50) print(f"Anon Key 업로드: {'[PASS] 성공' if anon_success else '[FAIL] 실패'}") print(f"Service Role 업로드: {'[PASS] 성공' if service_success else '[FAIL] 실패'}") if anon_success: print("\n[SUCCESS] Anon Key로 업로드 가능! RLS 정책이 올바르게 설정되었습니다.") elif service_success: print("\n[WARN] Service Role만 가능. RLS 정책 설정이 필요합니다.") print("[INFO] Supabase 대시보드에서 Storage 정책을 설정하세요.") else: print("\n[ERROR] 모든 업로드 실패. Storage 버킷이나 권한을 확인하세요.") if __name__ == "__main__": main() 