#!/usr/bin/env python3 """ BrickBox CLIP ì„ë² ë”© ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë°©ë²•: pip install openai-clip torch supabase python generate_embeddings.py í™˜ê²½ ë³€ìˆ˜: SUPABASE_URL, SUPABASE_KEY """ import os import sys import json import numpy as np from typing import List, Dict from tqdm import tqdm try: import torch import clip from supabase import create_client except ImportError as e: print(f" íŒ¨í‚¤ì§€ ì„¤ì¹˜ í•„ìš”: {e}") print("ì‹¤í–‰: pip install openai-clip torch supabase") sys.exit(1) # ============================================ # ì„¤ì • # ============================================ SUPABASE_URL = os.getenv("SUPABASE_URL") SUPABASE_KEY = os.getenv("SUPABASE_KEY") BATCH_SIZE = 10 DEVICE = "cuda" if torch.cuda.is_available() else "cpu" # ìƒ˜í”Œ ID (ì „ì²´ í™•ì¥ ì‹œ ìˆ˜ì •) PART_IDS = list(range(2124, 2134)) # 10ê±´ # ============================================ # ì´ˆê¸°í™” # ============================================ print("========================================") print(" BrickBox ì„ë² ë”© ìƒì„± ì‹œì‘") print("========================================") if not SUPABASE_URL or not SUPABASE_KEY: print(" í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í•„ìš”:") print(" export SUPABASE_URL='...'") print(" export SUPABASE_KEY='...'") sys.exit(1) print(f"ğŸ“± Device: {DEVICE}") print(f" ë°°ì¹˜ í¬ê¸°: {BATCH_SIZE}") print(f" ëŒ€ìƒ: {len(PART_IDS)}ê°œ ë¶€í’ˆ") print("") # CLIP ëª¨ë¸ ë¡œë“œ (ViT-L/14: 768ì°¨ì›) print(" CLIP ëª¨ë¸ ë¡œë“œ ì¤‘ (ViT-L/14, 768ì°¨ì›)...") try: model, preprocess = clip.load("ViT-L/14", device=DEVICE) model.eval() print(" CLIP ëª¨ë¸ ë¡œë“œ ì™„ë£Œ (768ì°¨ì›)") except Exception as e: print(f" CLIP ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}") sys.exit(1) # DB ì—°ê²° print(" Supabase ì—°ê²° ì¤‘...") try: supabase = create_client(SUPABASE_URL, SUPABASE_KEY) print(" Supabase ì—°ê²° ì™„ë£Œ") except Exception as e: print(f" Supabase ì—°ê²° ì‹¤íŒ¨: {e}") sys.exit(1) print("") # ============================================ # ë°ì´í„° ë¡œë“œ # ============================================ print("ğŸ“¥ ë¶€í’ˆ ë°ì´í„° ë¡œë“œ ì¤‘...") try: response = supabase.table('parts_master_features') \ .select('id, part_id, part_name, feature_text') \ .in_('id', PART_IDS) \ .execute() parts = response.data print(f" {len(parts)}ê°œ ë¶€í’ˆ ë¡œë“œ ì™„ë£Œ") except Exception as e: print(f" ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}") sys.exit(1) if not parts: print(" ë¶€í’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤") sys.exit(1) print("") # ============================================ # ì„ë² ë”© ìƒì„± # ============================================ print(" ì„ë² ë”© ìƒì„± ì¤‘...") print("========================================") success_count = 0 fail_count = 0 for i in tqdm(range(0, len(parts), BATCH_SIZE), desc="Progress"): batch = parts[i:i+BATCH_SIZE] try: # í…ìŠ¤íŠ¸ ì¤€ë¹„ texts = [p['feature_text'] or f"{p['part_name']} ë ˆê³  ë¶€í’ˆ" for p in batch] # CLIP ì„ë² ë”© text_tokens = clip.tokenize(texts, truncate=True).to(DEVICE) with torch.no_grad(): text_features = model.encode_text(text_tokens) text_features = text_features / text_features.norm(dim=-1, keepdim=True) # DB ì—…ë°ì´íŠ¸ for j, part in enumerate(batch): emb = text_features[j].cpu().numpy() emb_str = '[' + ','.join([f'{v:.6f}' for v in emb]) + ']' try: supabase.table('parts_master_features') \ .update({ 'clip_text_emb': emb_str, 'semantic_vector': emb_str, # ë™ì¼ ë²¡í„° ì‚¬ìš© 'updated_at': 'NOW()' }) \ .eq('id', part['id']) \ .execute() success_count += 1 except Exception as e: print(f"\n {part['part_id']} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}") fail_count += 1 except Exception as e: print(f"\n ë°°ì¹˜ {i} ì‹¤íŒ¨: {e}") fail_count += len(batch) print("") print("========================================") print(f" ì„±ê³µ: {success_count}ê°œ") print(f" ì‹¤íŒ¨: {fail_count}ê°œ") print("========================================") # ============================================ # ê²€ì¦ # ============================================ print("") print(" ì„ë² ë”© ê²€ì¦ ì¤‘...") try: response = supabase.table('parts_master_features') \ .select('id, part_id, clip_text_emb') \ .in_('id', PART_IDS) \ .limit(3) \ .execute() print("") print("ìƒ˜í”Œ í™•ì¸:") print("----------------------------------------") for part in response.data: emb = json.loads(part['clip_text_emb']) norm = np.linalg.norm(emb) status = " OK" if len(emb) == 768 and abs(norm - 1.0) < 0.01 else " FAIL" print(f"{status} {part['part_id']}") print(f" - ì°¨ì›: {len(emb)}") print(f" - ë…¸ë¦„: {norm:.4f}") print(f" - ìƒ˜í”Œ: [{emb[0]:.4f}, {emb[1]:.4f}, {emb[2]:.4f}, ...]") print("") print("========================================") print(" P0 ì„ë² ë”© ìƒì„± ì™„ë£Œ!") print("ë‹¤ìŒ ë‹¨ê³„: psql -f fix_metadata_p1.sql") print("========================================") except Exception as e: print(f" ê²€ì¦ ì‹¤íŒ¨: {e}") sys.exit(1) 