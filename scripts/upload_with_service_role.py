#!/usr/bin/env python3 """ BrickBox 렌더링 업로드 (Service Role Key 사용) RLS 정책 우회를 위해 Service Role Key 사용 """ import os import sys import json import time import logging from pathlib import Path from datetime import datetime from typing import List, Dict, Optional from supabase import create_client, Client # 로깅 설정 logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') logger = logging.getLogger(__name__) class ServiceRoleUploader: """Service Role Key를 사용한 업로더""" def __init__(self, supabase_url: str, service_role_key: str): self.supabase_url = supabase_url self.service_role_key = service_role_key self.supabase: Client = create_client(supabase_url, service_role_key) def upload_single_file(self, part_id: str, file_path: str, file_type: str = "image") -> bool: """단일 파일 업로드""" try: filename = os.path.basename(file_path) supabase_path = f"synthetic/{part_id}/{filename}" # 파일 읽기 with open(file_path, 'rb') as f: file_data = f.read() # MIME 타입 설정 content_type = "image/webp" if file_type == "image" else "text/plain" # 업로드 result = self.supabase.storage.from_('lego-synthetic').upload( supabase_path, file_data, file_options={"content-type": content_type, "upsert": "true"} ) if hasattr(result, 'error') and result.error: logger.error(f" 업로드 실패 {filename}: {result.error}") return False logger.info(f" 업로드 성공: {filename}") return True except Exception as e: logger.error(f" 업로드 오류 {filename}: {e}") return False def batch_upload(self, output_dir: str, batch_size: int = 10) -> Dict: """배치 업로드""" output_path = Path(output_dir) if not output_path.exists(): logger.error(f" 디렉토리가 존재하지 않습니다: {output_dir}") return {'success': False, 'message': '디렉토리 없음'} # 파일 스캔 files_to_upload = [] for part_folder in output_path.iterdir(): if part_folder.is_dir(): part_id = part_folder.name # 이미지 파일 스캔 image_files = list(part_folder.glob("*.webp")) + list(part_folder.glob("*.png")) + list(part_folder.glob("*.jpg")) annotation_files = list(part_folder.glob("*.txt")) for image_file in image_files: files_to_upload.append({ 'part_id': part_id, 'file_path': str(image_file), 'file_type': 'image' }) for annotation_file in annotation_files: files_to_upload.append({ 'part_id': part_id, 'file_path': str(annotation_file), 'file_type': 'annotation' }) logger.info(f" 업로드할 파일: {len(files_to_upload)}개") # 배치 업로드 success_count = 0 fail_count = 0 for i in range(0, len(files_to_upload), batch_size): batch = files_to_upload[i:i+batch_size] logger.info(f" 배치 {i//batch_size + 1} 처리 중 ({len(batch)}개 파일)") for file_info in batch: if self.upload_single_file( file_info['part_id'], file_info['file_path'], file_info['file_type'] ): success_count += 1 else: fail_count += 1 time.sleep(0.1) # API 제한 방지 # 배치 간 대기 if i + batch_size < len(files_to_upload): logger.info(f" 다음 배치까지 대기 중...") time.sleep(2) result = { 'success': fail_count == 0, 'total_files': len(files_to_upload), 'success_count': success_count, 'fail_count': fail_count, 'message': f'업로드 완료: {success_count}개 성공, {fail_count}개 실패' } logger.info(f" 배치 업로드 완료: {result['message']}") return result def main(): """메인 실행 함수""" if len(sys.argv) < 2: print("사용법: python upload_with_service_role.py <output_dir> [--batch-size N]") print("주의: SUPABASE_SERVICE_ROLE_KEY 환경변수가 필요합니다") sys.exit(1) output_dir = sys.argv[1] batch_size = 10 # 배치 크기 설정 if '--batch-size' in sys.argv: try: batch_size_idx = sys.argv.index('--batch-size') batch_size = int(sys.argv[batch_size_idx + 1]) except (ValueError, IndexError): logger.warning(" 잘못된 배치 크기, 기본값 사용") # Supabase 설정 supabase_url = os.getenv('VITE_SUPABASE_URL', 'https://npferbxuxocbfnfbpcnz.supabase.co') service_role_key = os.getenv('SUPABASE_SERVICE_ROLE_KEY') if not service_role_key: logger.error(" SUPABASE_SERVICE_ROLE_KEY 환경변수가 설정되지 않았습니다") logger.error(" Supabase 대시보드 → Settings → API → service_role key 복사") sys.exit(1) try: # Service Role 업로더 실행 uploader = ServiceRoleUploader(supabase_url, service_role_key) result = uploader.batch_upload(output_dir, batch_size) if result['success']: logger.info(" 업로드 성공!") else: logger.error(f" 업로드 실패: {result['message']}") sys.exit(1) except Exception as e: logger.error(f" 실행 오류: {e}") sys.exit(1) if __name__ == "__main__": main() 