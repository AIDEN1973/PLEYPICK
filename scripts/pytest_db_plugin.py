#!/usr/bin/env python3 """ BrickBox pytest DB 플러그인 pytest 실행 시 자동으로 결과를 DB에 저장 """ import pytest import os import sys from datetime import datetime from typing import Dict, Optional # 상위 디렉토리의 test_db_logger import sys.path.append(os.path.dirname(__file__)) from test_db_logger import TestDBLogger class PytestDBPlugin: """pytest DB 로깅 플러그인""" def __init__(self): self.db_logger = TestDBLogger() self.test_results = { "total": 0, "passed": 0, "failed": 0, "skipped": 0, "duration": 0.0, "test_files": [], "coverage": 0.0 } self.start_time = None @pytest.hookimpl(tryfirst=True) def pytest_sessionstart(self, session): """테스트 세션 시작""" self.start_time = datetime.now() print(f" 테스트 세션 시작: {self.start_time.isoformat()}") @pytest.hookimpl(trylast=True) def pytest_sessionfinish(self, session, exitstatus): """테스트 세션 종료""" if self.start_time: duration = (datetime.now() - self.start_time).total_seconds() self.test_results["duration"] = duration # 테스트 결과 DB 저장 self.db_logger.log_test_results(self.test_results) print(f" 테스트 세션 완료: {self.test_results}") @pytest.hookimpl(tryfirst=True) def pytest_runtest_setup(self, item): """개별 테스트 시작""" pass @pytest.hookimpl(tryfirst=True) def pytest_runtest_teardown(self, item, nextitem): """개별 테스트 종료""" pass @pytest.hookimpl(tryfirst=True) def pytest_runtest_logreport(self, report): """개별 테스트 결과 로깅""" if report.when == "call": # 테스트 실행 완료 시 test_name = f"{report.nodeid}::{report.fspath.basename}" status = "PASSED" if report.outcome == "passed" else "FAILED" duration = getattr(report, 'duration', 0.0) error_message = str(report.longrepr) if hasattr(report, 'longrepr') and report.longrepr else None # 개별 테스트 결과 DB 저장 self.db_logger.log_individual_test( test_name=test_name, status=status, duration=duration, error_message=error_message ) # 전체 결과 업데이트 self.test_results["total"] += 1 if report.outcome == "passed": self.test_results["passed"] += 1 elif report.outcome == "failed": self.test_results["failed"] += 1 elif report.outcome == "skipped": self.test_results["skipped"] += 1 @pytest.hookimpl(tryfirst=True) def pytest_collection_modifyitems(self, session, config, items): """테스트 수집 후 수정""" self.test_results["test_files"] = list(set([item.fspath.basename for item in items])) @pytest.hookimpl(tryfirst=True) def pytest_terminal_summary(self, terminalreporter, exitstatus, config): """터미널 요약 출력""" terminalreporter.write_sep("=", "BrickBox 테스트 결과 DB 저장") terminalreporter.write_line(f"총 테스트: {self.test_results['total']}") terminalreporter.write_line(f"성공: {self.test_results['passed']}") terminalreporter.write_line(f"실패: {self.test_results['failed']}") terminalreporter.write_line(f"건너뛰기: {self.test_results['skipped']}") terminalreporter.write_line(f"실행 시간: {self.test_results['duration']:.2f}초") terminalreporter.write_line(" 결과가 operation_logs 테이블에 저장되었습니다.") def pytest_configure(config): """pytest 설정 시 플러그인 등록""" config.pluginmanager.register(PytestDBPlugin(), "brickbox_db_plugin") 