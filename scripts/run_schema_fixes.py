#!/usr/bin/env python3 """ BrickBox ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ operation_logs í…Œì´ë¸” ìˆ˜ì • ë° qa_logs í…Œì´ë¸” ìƒì„± """ import os import sys import logging from pathlib import Path from dotenv import load_dotenv from supabase import create_client, Client # ë¡œê¹… ì„¤ì • logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') logger = logging.getLogger(__name__) def load_environment(): """í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ""" load_dotenv() supabase_url = os.getenv('VITE_SUPABASE_URL') supabase_key = os.getenv('VITE_SUPABASE_ANON_KEY') if not supabase_url or not supabase_key: logger.error(" Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.") logger.error(f"VITE_SUPABASE_URL: {supabase_url}") logger.error(f"VITE_SUPABASE_ANON_KEY: {'ì„¤ì •ë¨' if supabase_key else 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}") sys.exit(1) return supabase_url, supabase_key def execute_sql_script(supabase: Client, sql_content: str, description: str) -> bool: """SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰""" try: logger.info(f"ğŸ“ {description} ì‹¤í–‰ ì¤‘...") # SQLì„ ê°œë³„ ëª…ë ¹ì–´ë¡œ ë¶„í•  sql_commands = [cmd.strip() for cmd in sql_content.split(';') if cmd.strip()] for i, sql in enumerate(sql_commands, 1): if not sql: continue logger.info(f" {i}/{len(sql_commands)}: {sql[:50]}...") try: # Supabase RPCë¥¼ í†µí•œ SQL ì‹¤í–‰ result = supabase.rpc('exec_sql', {'sql': sql}) logger.info(f" ì„±ê³µ: {sql[:30]}...") except Exception as e: # ì¼ë¶€ ëª…ë ¹ì–´ëŠ” ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ ì¶œë ¥ if "already exists" in str(e).lower() or "duplicate" in str(e).lower(): logger.warning(f" ì´ë¯¸ ì¡´ì¬: {sql[:30]}...") else: logger.error(f" ì‹¤íŒ¨: {sql[:30]}... - {e}") return False logger.info(f" {description} ì™„ë£Œ!") return True except Exception as e: logger.error(f" {description} ì‹¤íŒ¨: {e}") return False def main(): """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜""" logger.info(" BrickBox ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìˆ˜ì • ì‹œì‘...") # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ supabase_url, supabase_key = load_environment() # Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± try: supabase: Client = create_client(supabase_url, supabase_key) logger.info(" Supabase ì—°ê²° ì„±ê³µ") except Exception as e: logger.error(f" Supabase ì—°ê²° ì‹¤íŒ¨: {e}") sys.exit(1) # SQL ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ script_path = Path(__file__).parent.parent / "run_schema_fixes.sql" if not script_path.exists(): logger.error(f" SQL ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {script_path}") sys.exit(1) try: with open(script_path, 'r', encoding='utf-8') as f: sql_content = f.read() logger.info(" SQL ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ") except Exception as e: logger.error(f" SQL ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨: {e}") sys.exit(1) # SQL ì‹¤í–‰ success = execute_sql_script(supabase, sql_content, "ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •") if success: logger.info(" ëª¨ë“  ìŠ¤í‚¤ë§ˆ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!") logger.info(" ì´ì œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ê°€ í•´ê²°ë  ê²ƒì…ë‹ˆë‹¤.") else: logger.error(" ìŠ¤í‚¤ë§ˆ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.") sys.exit(1) if __name__ == "__main__": main() 