# Semantic Vector 품질 보증 가이드

## 개요

수동 생성 방식을 유지하면서 Semantic Vector 품질을 최대한 보증하기 위한 검증 로직입니다.

---

## 품질 보증 단계

### 1. 이미지 URL 사전 검증

**목적**: API 호출 전에 이미지 URL 유효성 확인

**검증 항목**:
- HTTP HEAD 요청으로 이미지 존재 확인
- Content-Type이 `image/*`로 시작하는지 확인
- 5초 타임아웃 설정

**실패 시**: API 호출 없이 즉시 건너뛰기

---

### 2. API 응답 검증

**목적**: API 서버 응답의 기본 유효성 확인

**검증 항목**:
- HTTP 상태 코드 확인 (200 OK)
- JSON 응답 구조 확인
- `success` 필드 확인
- `semanticVector` 필드 존재 및 타입 확인

---

### 3. 벡터 데이터 타입 검증

**목적**: 벡터가 올바른 형식인지 확인

**검증 항목**:
- 배열 타입 확인
- 빈 배열 체크
- 문자열 요소를 숫자로 변환
- NaN, Infinity 값 체크

**오류 메시지**:
- "생성된 벡터가 유효하지 않습니다 (null 또는 배열 아님)"
- "생성된 벡터가 비어있습니다"
- "벡터 값 파싱 실패"
- "벡터에 NaN 또는 Infinity가 포함되어 있습니다"

---

### 4. 원본 벡터 품질 검증 (확장 전)

**목적**: FGC Encoder가 생성한 원본 벡터의 품질 확인

**검증 항목**:
- 원본 벡터 norm 계산
- norm이 최소 0.001 이상인지 확인

**오류 메시지**:
- "원본 벡터 norm이 너무 작습니다: {norm}"

---

### 5. 벡터 차원 확장 검증

**목적**: 512D → 768D 확장 과정 검증

**검증 항목**:
- 입력 벡터 차원 확인 (512D 또는 768D)
- 확장 계산 중 유효성 확인
- 확장된 벡터의 유효성 확인

**오류 메시지**:
- "벡터 차원이 올바르지 않습니다: {length}D"
- "확장 벡터 계산 중 오류 발생"

---

### 6. 벡터 정규화 검증

**목적**: L2 정규화가 올바르게 수행되었는지 확인

**검증 항목**:
- 정규화 전 norm 확인 (최소 0.01 이상)
- L2 정규화 수행
- 정규화 후 norm 확인 (1.0 ± 0.1 범위)

**오류 메시지**:
- "벡터 norm이 너무 작습니다: {norm} (최소 0.01 필요)"
- "정규화 계산 중 오류 발생"
- "정규화 실패: norm={norm} (예상: 1.0)"

---

### 7. 제로벡터 최종 검증

**목적**: 정규화 후에도 제로벡터가 아닌지 확인

**검증 항목**:
- 벡터 내 0이 아닌 값 존재 확인 (1e-10 이상)

**오류 메시지**:
- "정규화 후에도 모든 값이 0입니다 (제로벡터)"

---

### 8. 벡터 값 범위 검증

**목적**: 비정상적으로 큰 값이 포함되지 않았는지 확인

**검증 항목**:
- 벡터 내 최대 절댓값 확인 (10 이하여야 함)

**오류 메시지**:
- "벡터 값 범위가 비정상적입니다: max_abs={maxAbs}"

---

### 9. 저장 전 최종 검증

**목적**: DB 저장 전 최종 품질 확인

**검증 항목**:
- 벡터 차원 확인 (768D)
- 정규화된 norm 확인 (1.0 ± 0.1)
- 모든 값이 유한한 숫자인지 확인

**오류 메시지**:
- "최종 벡터 차원 오류: {length}D"
- "최종 벡터 norm 오류: {norm}"
- "최종 벡터에 유효하지 않은 값이 있습니다: {value}"

---

### 10. 저장 후 검증

**목적**: DB에 올바르게 저장되었는지 확인

**검증 항목**:
- 저장된 벡터 재조회
- 저장된 벡터 norm 확인 (최소 0.1 이상)

**오류 메시지**:
- "저장 후 검증 실패: 벡터가 저장되지 않았습니다"
- "저장 후 검증 실패: norm={norm}"

---

## 벡터 검증 함수 (`validateVector`)

### 검증 단계

1. **기본 타입 체크**: 배열 타입 및 길이 확인
2. **차원 검증**: 768차원 필수
3. **숫자 변환**: 문자열 요소를 숫자로 변환
4. **NaN/Infinity 체크**: 유효하지 않은 값 제거
5. **제로벡터 체크**: 모든 값이 0인지 확인
6. **Norm 검증**: 
   - 최소 0.1 이상
   - 1.0 ± 0.1 범위 (정규화 여부)
7. **값 범위 검증**: 최대 절댓값 10 이하
8. **제로 패딩 검증**: 뒷부분 256개 중 80% 이상이 0이 아닌지 확인

---

## 제로벡터 감지 로직

### 일괄 생성 시 제로벡터 감지

**검증 단계**:
1. DB에서 벡터 조회
2. 문자열 배열인 경우 JSON 파싱
3. 배열 타입 및 길이 확인
4. 모든 값이 0인지 확인 (1e-10 기준)

**제로벡터로 간주되는 경우**:
- `semantic_vector`가 null
- 배열이 아님
- 빈 배열
- 모든 값이 0 (1e-10 이하)

---

## 에러 처리

### 실패 시 처리

1. **이미지 URL 검증 실패**:
   - API 호출 없이 건너뛰기
   - 결과에 실패 기록

2. **API 요청 실패**:
   - HTTP 상태 코드 확인
   - 에러 메시지 기록

3. **벡터 품질 검증 실패**:
   - 각 검증 단계에서 즉시 실패 처리
   - 상세한 오류 메시지 제공
   - DB 저장하지 않음

4. **DB 저장 실패**:
   - 저장 후 검증 실패 시에도 에러 기록
   - 재시도 가능하도록 상태 유지

---

## 품질 지표

### 성공적인 벡터의 특징

- **차원**: 정확히 768D
- **Norm**: 0.9 ~ 1.1 범위 (정규화됨)
- **값 범위**: -1 ~ 1 범위 (정규화된 벡터)
- **제로값**: 최소 하나 이상의 0이 아닌 값
- **제로 패딩**: 뒷부분 256개 중 최소 20% 이상이 0이 아님
- **NaN/Infinity**: 없음

---

## 모니터링

### 로그 기록 항목

- 이미지 URL 검증 결과
- API 호출 결과
- 각 검증 단계 통과 여부
- 최종 norm 값
- 원본 norm 값 (확장 전)
- 처리 시간

### 결과 테이블 항목

- `partId`: 부품 ID
- `colorId`: 색상 ID
- `success`: 성공 여부
- `dimensions`: 벡터 차원
- `norm`: 정규화된 norm
- `originalNorm`: 원본 벡터 norm
- `method`: 생성 방법 (FGC-Encoder)
- `processingTime`: 처리 시간 (ms)
- `error`: 에러 메시지 (실패 시)

---

## 개선 사항 요약

### 추가된 검증

1. ✅ 이미지 URL 사전 검증
2. ✅ API 응답 상태 코드 확인
3. ✅ 벡터 타입 및 형식 검증 강화
4. ✅ 원본 벡터 품질 검증 (확장 전)
5. ✅ 정규화 과정 검증 강화
6. ✅ 제로벡터 다단계 검증
7. ✅ 벡터 값 범위 검증
8. ✅ 저장 전 최종 검증
9. ✅ 저장 후 검증 (재조회)

### 검증 함수 개선

1. ✅ 8단계 검증 로직 추가
2. ✅ 제로 패딩 감지 로직 추가
3. ✅ Norm 정규화 검증 강화
4. ✅ 문자열 배열 파싱 지원

---

## 사용 가이드

### 일괄 생성 시

1. "일괄 생성 시작" 버튼 클릭
2. 각 부품에 대해 10단계 검증 자동 수행
3. 실패한 부품은 결과 테이블에 에러 메시지 표시
4. 성공한 부품은 norm 값과 함께 표시

### 개별 생성 시

1. 부품 선택 후 "생성" 버튼 클릭
2. 동일한 10단계 검증 수행
3. 결과 즉시 표시

### 벡터 검증 버튼

1. "벡터 검증" 버튼 클릭
2. 모든 벡터에 대해 `validateVector` 함수 실행
3. 무효 벡터 발견 시 수정 옵션 제공

---

## 문제 해결

### 제로벡터가 감지되는 경우

1. 이미지 URL 확인
2. API 서버 상태 확인
3. FGC Encoder 모델 로드 확인
4. 네트워크 연결 확인

### 정규화 실패하는 경우

1. 원본 벡터 norm 확인
2. 확장 과정 확인
3. 계산 오버플로우 확인

### 저장 후 검증 실패하는 경우

1. DB 연결 확인
2. VECTOR 타입 컬럼 확인
3. 권한 확인

---

## 참고

- 모든 검증은 수동 생성 방식에서 실행됩니다
- 자동 재시도는 제공되지 않습니다 (사용자가 수동으로 재시도)
- 실패한 부품은 결과 테이블에서 확인 가능합니다

