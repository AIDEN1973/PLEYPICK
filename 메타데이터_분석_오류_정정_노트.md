# ğŸ” ë©”íƒ€ë°ì´í„° ë¶„ì„ ì˜¤ë¥˜ ì •ì • ë…¸íŠ¸

**ë‚ ì§œ**: 2025-10-13  
**ê´€ë ¨ ë¬¸ì„œ**: `ë©”íƒ€ë°ì´í„°_ë¬¸ì„œ_ì •í•©ì„±_ë¶„ì„_ë³´ê³ ì„œ_20251013.md`

---

## âŒ ë°œê²¬ëœ ë¶„ì„ ì˜¤ë¥˜

### Critical #4 "í•„ìˆ˜ í•„ë“œ ëˆ„ë½ (set_id, element_id)" â†’ **ë¬´íš¨**

#### ì˜ëª»ëœ ë¶„ì„:
> "set_id: ì„¸íŠ¸ IDê°€ ì—†ì–´ BOM ì œì•½ ë¶ˆê°€"  
> "element_id: ì—˜ë¦¬ë¨¼íŠ¸ IDê°€ ì—†ì–´ ë¶€í’ˆ ê³ ìœ  ì‹ë³„ ë¶ˆê°€"

#### ì˜¤ë¥˜ ì›ì¸:
- ë©”íƒ€ë°ì´í„°.txtì˜ "set_id, element_id"ë¥¼ **ë Œë”ë§ ë°ì´í„°ì…‹ ë©”íƒ€ë°ì´í„°**ê°€ ì•„ë‹Œ **parts_master_features í…Œì´ë¸” í•„ë“œ**ë¡œ ì˜ëª» í•´ì„
- ë°ì´í„°ë² ì´ìŠ¤ ì •ê·œí™” ì›ì¹™ì„ ê°„ê³¼

---

## âœ… ì˜¬ë°”ë¥¸ ì´í•´

### 1. parts_master_featuresëŠ” ë¶€í’ˆ ë§ˆìŠ¤í„° ì¹´íƒˆë¡œê·¸

**ìš©ë„**: ë¶€í’ˆ ìì²´ì˜ ê³ ìœ  íŠ¹ì§• ì €ì¥  
**ê´€ê³„**: 1ê°œ ë¶€í’ˆ = 1ê°œ ë ˆì½”ë“œ

```sql
CREATE TABLE parts_master_features (
  part_id VARCHAR(20),     -- ë¶€í’ˆ ID
  color_id INTEGER,        -- ìƒ‰ìƒ ID
  series VARCHAR(20),      -- âœ… ë¶€í’ˆ ì‹œë¦¬ì¦ˆ (system/duplo/technic)
  shape_tag VARCHAR(20),   -- âœ… ë¶€í’ˆ í˜•íƒœ (plate/brick/tile)
  feature_text TEXT,
  clip_text_emb VECTOR(768),
  -- set_id ì—†ìŒ! âŒ
  UNIQUE(part_id, color_id)
);
```

### 2. set_partsëŠ” ì„¸íŠ¸-ë¶€í’ˆ ê´€ê³„ í…Œì´ë¸”

**ìš©ë„**: ì–´ë–¤ ì„¸íŠ¸ì— ì–´ë–¤ ë¶€í’ˆì´ ëª‡ ê°œ ë“¤ì–´ê°€ëŠ”ì§€ ê´€ë¦¬  
**ê´€ê³„**: 1ê°œ ë¶€í’ˆì´ Nê°œ ì„¸íŠ¸ì—ì„œ ì‚¬ìš© (1:N)

```sql
CREATE TABLE set_parts (
  set_id VARCHAR(20),      -- âœ… ì„¸íŠ¸ IDëŠ” ì—¬ê¸°!
  element_id VARCHAR(20),  -- âœ… Rebrickable ê³ ìœ  ID
  part_id VARCHAR(20),
  color_id INTEGER,
  quantity INTEGER,
  PRIMARY KEY (set_id, part_id, color_id)
);
```

### 3. ì‹¤ì œ ë°ì´í„° ì˜ˆì‹œ

**ë¶€í’ˆ: "3020 Black Plate"**

```
parts_master_features (1ê°œ ë ˆì½”ë“œ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ part_id  â”‚ color_id â”‚ series  â”‚ shape_tag â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3020     â”‚ 11       â”‚ system  â”‚ plate     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

set_parts (Nê°œ ë ˆì½”ë“œ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ set_id   â”‚ element_id â”‚ part_id  â”‚ color_id â”‚ quantity â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 76917    â”‚ 302001     â”‚ 3020     â”‚ 11       â”‚ 4        â”‚
â”‚ 60317    â”‚ 302001     â”‚ 3020     â”‚ 11       â”‚ 2        â”‚
â”‚ 10295    â”‚ 302001     â”‚ 3020     â”‚ 11       â”‚ 8        â”‚
â”‚ ...      â”‚ ...        â”‚ ...      â”‚ ...      â”‚ ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(ìˆ˜ë°± ê°œ ë ˆì½”ë“œ)
```

---

## ğŸ”„ ì™œ set_idë¥¼ parts_master_featuresì— ë„£ìœ¼ë©´ ì•ˆ ë˜ë‚˜?

### âŒ ì˜ëª»ëœ ëª¨ë¸ (ì •ê·œí™” ìœ„ë°°):

```
parts_master_featuresì— set_idë¥¼ ë„£ìœ¼ë©´:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ part_id  â”‚ color_id â”‚ set_id   â”‚ feature_textâ”‚ embedding â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3020     â”‚ 11       â”‚ 76917    â”‚ Plate 2x4   â”‚ [768ì°¨ì›] â”‚ â† ì¤‘ë³µ!
â”‚ 3020     â”‚ 11       â”‚ 60317    â”‚ Plate 2x4   â”‚ [768ì°¨ì›] â”‚ â† ì¤‘ë³µ!
â”‚ 3020     â”‚ 11       â”‚ 10295    â”‚ Plate 2x4   â”‚ [768ì°¨ì›] â”‚ â† ì¤‘ë³µ!
â”‚ ...      â”‚ ...      â”‚ ...      â”‚ ...         â”‚ ...       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë¬¸ì œì :
1. ë™ì¼í•œ ë¶€í’ˆ íŠ¹ì§•ì´ ìˆ˜ë°± ë²ˆ ì¤‘ë³µ ì €ì¥
2. feature_text, embedding ë“± ëŒ€ìš©ëŸ‰ ë°ì´í„° ì¤‘ë³µ
3. ë¶€í’ˆ íŠ¹ì§• ì—…ë°ì´íŠ¸ ì‹œ ëª¨ë“  ë ˆì½”ë“œ ìˆ˜ì • í•„ìš”
4. ìŠ¤í† ë¦¬ì§€ ë‚­ë¹„ (768ì°¨ì› ë²¡í„° Ã— ìˆ˜ë°± ë°°)
```

### âœ… ì˜¬ë°”ë¥¸ ëª¨ë¸ (ì •ê·œí™” ìœ ì§€):

```
parts_master_features (ë¶€í’ˆ ë§ˆìŠ¤í„°):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ part_id  â”‚ color_id â”‚ feature_textâ”‚ embedding â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3020     â”‚ 11       â”‚ Plate 2x4   â”‚ [768ì°¨ì›] â”‚ â† 1ê°œë§Œ!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

set_parts (ê´€ê³„ í…Œì´ë¸”):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ set_id   â”‚ part_id  â”‚ color_id â”‚ quantity â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 76917    â”‚ 3020     â”‚ 11       â”‚ 4        â”‚
â”‚ 60317    â”‚ 3020     â”‚ 11       â”‚ 2        â”‚
â”‚ 10295    â”‚ 3020     â”‚ 11       â”‚ 8        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì¥ì :
1. ë¶€í’ˆ íŠ¹ì§•ì€ ë‹¨ 1ë²ˆë§Œ ì €ì¥
2. ìŠ¤í† ë¦¬ì§€ íš¨ìœ¨ì 
3. ìœ ì§€ë³´ìˆ˜ ìš©ì´
4. í‘œì¤€ ë°ì´í„°ë² ì´ìŠ¤ ì •ê·œí™” ì¤€ìˆ˜
```

---

## ğŸ¯ BOM ì œì•½ì€ ì–´ë–»ê²Œ?

**ì§ˆë¬¸**: set_idê°€ ì—†ìœ¼ë©´ BOM ì œì•½ì„ ì–´ë–»ê²Œ í•˜ë‚˜?

**ë‹µë³€**: ëŸ°íƒ€ì„ì— set_parts í…Œì´ë¸”ì„ ì¡°íšŒí•©ë‹ˆë‹¤!

```javascript
// BOM ì œì•½ ë¡œì§ (ì˜ì‚¬ì½”ë“œ)
async function detectPartsInFrame(frame, setId) {
  // 1. í”„ë ˆì„ì—ì„œ ë¶€í’ˆ íƒì§€
  const detectedParts = await yolo.detect(frame)
  
  // 2. í•´ë‹¹ ì„¸íŠ¸ì˜ BOM ì¡°íšŒ (set_parts í…Œì´ë¸”)
  const { data: bomParts } = await supabase
    .from('set_parts')
    .select('part_id, color_id, quantity')
    .eq('set_id', setId)
  
  // 3. BOM ì œì•½ ì ìš©
  const result = applyBOMConstraints(detectedParts, bomParts)
  
  return result
}
```

---

## ğŸ“ ë©”íƒ€ë°ì´í„°.txtì˜ "set_id, element_id"ëŠ”?

ë©”íƒ€ë°ì´í„°.txt (Line 40-43):
```
ì‹ë³„: set_id, element_id, part_id, color_id
```

ì´ê²ƒì€ **ë Œë”ë§ ë°ì´í„°ì…‹ ë©”íƒ€ë°ì´í„°**ë¥¼ ë§í•˜ëŠ” ê²ƒ:

```
/dataset_{SET_ID}/                    â† íŠ¹ì • ì„¸íŠ¸ì˜ í•©ì„± ë°ì´í„°ì…‹
  images/train/302001/uuid.webp       â† element_idë³„ ì´ë¯¸ì§€
  meta/302001/uuid.json               â† ë Œë”ë§ ë©”íƒ€ë°ì´í„°
    {
      "set_id": "76917",              â† ì´ ë Œë”ë§ì´ ì–´ëŠ ì„¸íŠ¸ìš©ì¸ì§€
      "element_id": "302001",         â† ì–´ë–¤ ë¶€í’ˆ(+ìƒ‰ìƒ)ì„ ë Œë”ë§í–ˆëŠ”ì§€
      "part_id": "3020",
      "color_id": 11,
      "pose": {...},
      "lighting": {...}
    }
```

**parts_master_features í…Œì´ë¸”**ê³¼ëŠ” ë³„ê°œì…ë‹ˆë‹¤!

---

## âœ… series í•„ë“œëŠ” í•„ìš”í•œê°€?

**ë‹µ**: ë„¤! seriesëŠ” **ë¶€í’ˆ ìì²´ì˜ ì†ì„±**ì´ë¯€ë¡œ í•„ìš”í•©ë‹ˆë‹¤.

```javascript
{
  part_id: "4282",
  part_name: "Duplo Plate 2 x 2",
  series: "duplo",      // âœ… ë¶€í’ˆ ìì²´ê°€ Duplo ì œí’ˆêµ°
  shape_tag: "plate"
}

{
  part_id: "32523",
  part_name: "Technic Axle Pin",
  series: "technic",    // âœ… ë¶€í’ˆ ìì²´ê°€ Technic ì œí’ˆêµ°
  shape_tag: "axle"
}

{
  part_id: "3020",
  part_name: "Plate 2 x 4",
  series: "system",     // âœ… ì¼ë°˜ ë ˆê³  (ê¸°ë³¸ê°’)
  shape_tag: "plate"
}
```

**ì°¨ì´ì **:
- **series**: ë¶€í’ˆì˜ ì œí’ˆêµ° (Duplo/Technic/System) â†’ `parts_master_features` âœ…
- **set_id**: ë¶€í’ˆì´ ì†í•œ ì„¸íŠ¸ (76917/60317 ë“±) â†’ `set_parts` âœ…

---

## ğŸ› ï¸ ìˆ˜ì •ëœ SQL ìŠ¤í¬ë¦½íŠ¸

`database/fix_critical_schema_issues.sql`ì—ì„œ:

```sql
-- âœ… ì¶”ê°€í•´ì•¼ í•  ê²ƒ:
ALTER TABLE parts_master_features 
ADD COLUMN IF NOT EXISTS series VARCHAR(20);

ALTER TABLE parts_master_features 
ADD COLUMN IF NOT EXISTS shape_tag VARCHAR(20);

-- âŒ ì¶”ê°€í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ:
-- ALTER TABLE parts_master_features 
-- ADD COLUMN IF NOT EXISTS set_id VARCHAR(20);  -- ì •ê·œí™” ìœ„ë°°!
```

---

## ğŸ“Š ìˆ˜ì •ëœ Critical ì´ìŠˆ ëª©ë¡

| # | ì´ìŠˆ | ì‹¬ê°ë„ | ìƒíƒœ |
|---|------|--------|------|
| 1 | ë²¡í„° ì°¨ì› ë¶ˆì¼ì¹˜ (1536â†’768) | ğŸ”´ CRITICAL | âœ… ìœ íš¨ |
| 2 | series í•„ë“œ ëˆ„ë½ | ğŸ”´ CRITICAL | âœ… ìœ íš¨ |
| 3 | shape_tag íƒ€ì… ë¶ˆì¼ì¹˜ | ğŸ”´ CRITICAL | âœ… ìœ íš¨ |
| ~~4~~ | ~~set_id, element_id ëˆ„ë½~~ | ~~ğŸ”´ CRITICAL~~ | âŒ **ë¬´íš¨** |
| 4 | ìë™ ë§¤í•‘ ë¡œì§ ë¯¸êµ¬í˜„ | ğŸ”´ CRITICAL | âœ… ìœ íš¨ |

**ì´ Critical ì´ìŠˆ**: 5ê°œ â†’ 4ê°œ

---

## ğŸ“ êµí›ˆ

1. **ì •ê·œí™” ì›ì¹™ ì¤€ìˆ˜**: 1:N ê´€ê³„ëŠ” ë³„ë„ í…Œì´ë¸”ë¡œ ë¶„ë¦¬
2. **ë¬¸ë§¥ íŒŒì•…**: ë¬¸ì„œì˜ "set_id"ê°€ ì–´ëŠ ë§¥ë½ì—ì„œ ì–¸ê¸‰ëœ ê²ƒì¸ì§€ í™•ì¸
3. **ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€ ê³ ë ¤**: "í•˜ë‚˜ì˜ ë¶€í’ˆì´ ì—¬ëŸ¬ ì„¸íŠ¸ì—ì„œ ì‚¬ìš©"ë˜ëŠ” ì  ê³ ë ¤
4. **ë°ì´í„° ì¤‘ë³µ ë°©ì§€**: íŠ¹íˆ ëŒ€ìš©ëŸ‰ ë°ì´í„°(768ì°¨ì› ë²¡í„°)ëŠ” ì¤‘ë³µ ì €ì¥ ê¸ˆì§€

---

**ì‘ì„±ì**: AI Assistant  
**ê²€í† **: ì‚¬ìš©ì í”¼ë“œë°±ìœ¼ë¡œ ì˜¤ë¥˜ ë°œê²¬ ë° ìˆ˜ì •  
**ê°ì‚¬**: ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ìœ¼ë¡œ ë¶„ì„ ì˜¤ë¥˜ë¥¼ ì°¾ì•„ì£¼ì‹  ì‚¬ìš©ìê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤! ğŸ™


